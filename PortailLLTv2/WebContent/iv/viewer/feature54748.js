actuate.util.Package.define("actuate.iv.ui.dialog.aggregation");actuate.iv.ui.dialog.aggregation.IVAggregationAccordionDialog=actuate.Class.create();actuate.iv.ui.dialog.aggregation.IVAggregationAccordionDialog.prototype=actuate.Class.extend(new actuate.iv.ui.dialog.AbstractIVDialog(),{_classname:"actuate.iv.ui.dialog.aggregation.IVAggregationAccordionDialog",_htmlElements:{"_add":null,"_blocksContainer":null},_width:483,getFunctionList:function(){return new Array({name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.FIRST"),value:"FIRST"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.LAST"),value:"LAST"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.COUNT"),value:"COUNT"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.MAX"),value:"MAX"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.MIN"),value:"MIN"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.COUNTVALUE"),value:"COUNTDISTINCT"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.SUM"),value:"SUM"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.AVERAGE"),value:"AVE"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.MEDIAN"),value:"MEDIAN"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.STDEV"),value:"STDDEV"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.VAR"),value:"VARIANCE"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.MODE"),value:"MODE"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.WEIGHTEDAVERAGE"),value:"WEIGHTEDAVE"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.QUARTILE"),value:"QUARTILE"});},aggrBlocks:[],aggrBlockDivs:[],accordion:null,_container:null,_manager:null,selectedColumns:[],selectedColumnsBinding:[],functionStore:[],_selectControlsArray:null,initialize:function(){var A=this._getId(this._classname);this._applyHtmlElementsNames(A);actuate.iv.ui.dialog.AbstractIVDialog.prototype.initialize.call(this,A);this._container=document.getElementById(this._htmlElements["_blocksContainer"]);this.functionList=this.getFunctionList();this.aggregationBlocks=new Array();this._local_installEventHandlers();},_localBind:function(A){if(!A){return ;}this.setData(A);},_okPress:function(){if(this.isValid()){this._viewer.eventDispatcher.fireEvent(actuate.iv.core.iVEvent.__E_SETCOLUMNAGGREGATION,this._createColumnAggreationRequest());this._hide();}else{this._viewer.eventDispatcher.broadcastEvent(actuate.iv.core.iVEvent.__E_WARN,actuate.util.Utility.getLocalizedString("columnAggregationDialog.invalidFunction"));}},isValid:function(){var D=true;for(var C=0;C<this.selectedColumns.length;C++){for(var B=0;B<this.aggregationBlocks[C].length;B++){var A=this.aggregationBlocks[C][B];if(!A.isVisible()){continue;}if(!A.isValid()){return false;}}}return D;},_createColumnAggreationRequest:function(){var G=actuate.util.XmlDom.createXMLDom(actuate.util.Constants.soap.NAMESPACE_ACTUATE10,actuate.Constant.tag.Data);var A=actuate.util.XmlDom.createElement(G,actuate.Constant.tag.COLUMNDEFS);G.documentElement.appendChild(A);for(var E=0;E<this.selectedColumns.length;E++){var F=actuate.util.XmlDom.createElement(G,actuate.Constant.tag.ColumnDef);for(var C=0;C<this.aggregationBlocks[E].length;C++){var B=this.aggregationBlocks[E][C];if(!B.isVisible()){continue;}var H=B.createAggrElement(G,C);if(H!=null){F.appendChild(H);}}var D=B.createBoundDataColumnNode(G,this.selectedColumnsBinding[E]);if(D){F.appendChild(D);}A.appendChild(F);}return G;},__getHelpTopic:function(){return"iv_aggregation";},_initAccordion:function(){var B=this._init_htmlContent();this.selectedColumnsDiv=B;var D=[];for(var A=0;A<B.length;A++){this._initAggrBlocks(A,B[A].id);var C=new actuate.uiadapter.Panel({title:this.selectedColumns[A].bindingName,cls:"accordionSlideBorder ",border:false,contentEl:B[A].id});D[A]=C.panel;}this.accordion=new actuate.uiadapter.Panel({header:false,plain:true,layout:"accordion",layoutConfig:{width:480,height:"auto",minHeight:240,animDuration:100,fill:false},border:true,cls:"accordionBorder accordion-container-hidden ",items:D});this._afterExpand_c=actuate.Method.bind(this._afterExpand,this);this._afterCollapse_c=actuate.Method.bind(this._afterCollapse,this);var E=this.accordion.panel.items.items;for(var A=0;A<E.length;A++){this.accordion.registerEventHandler(E[A],"expand",this._afterExpand_c);this.accordion.registerEventHandler(E[A],"collapse",this._afterCollapse_c);}this.accordion.render(this._htmlElements["_blocksContainer"]);},_init_htmlContent:function(){var B=[];for(var A=0;A<this.selectedColumns.length;A++){B[A]=document.createElement("DIV");B[A].id="_AggrContainer"+A;this._container.appendChild(B[A]);}return B;},_initAggrBlocks:function(C,E){var B=this.element.aggregations[this.selectedColumns[C].getBinding().name];if(this.aggregationBlocks[C].length<1){var A=new actuate.iv.ui.dialog.aggregation.IVAggregationBlock(this,this.selectedColumnsBinding[C]);A.setAggrBlockColumnIndex(C);this.aggregationBlocks[C].push(A);var D=this.aggregationBlocks[C].length-1;this.aggregationBlocks[C][D].blockIndex=D;A.render(E);}if(B){for(var D=0;D<this.aggregationBlocks[C].length;D++){this.aggregationBlocks[C][D].hide();}for(var D=0;D<B.length;D++){if(this.aggregationBlocks[C][D]){var A=this.aggregationBlocks[C][D];A.selectedColumn=this.selectedColumnsBinding[C];A.setData(B[D]);A.show();}else{var A=new actuate.iv.ui.dialog.aggregation.IVAggregationBlock(this,this.selectedColumnsBinding[C]);A.setAggrBlockColumnIndex(C);this.aggregationBlocks[C].push(A);var D=this.aggregationBlocks[C].length-1;this.aggregationBlocks[C][D].blockIndex=D;A.render(E);A.setData(B[D]);A.show();}}}else{for(var D=0;D<this.aggregationBlocks[C].length;D++){var A=this.aggregationBlocks[C][D];A.selectedColumn=this.selectedColumnsBinding[C];A.setData(null);if(D>0){A.hide();}else{A.show();}}}},_local_installEventHandlers:function(){this.addAggregationLink=document.getElementById(this._htmlElements["_add"]);this._eh_addAggregationClick_c=actuate.Method.bindAsEventListener(this._eh_addAggregationClick,this);actuate.util.Event.observe(this.addAggregationLink,"click",this._eh_addAggregationClick_c,false);},setData:function(E){var F=E[actuate.model.Constant.MetadataType.ELEMENT];this.element=F;this.selectedColumns=[];this.selectedColumnsBinding=[];for(var G=0;G<E.selectedColumn.length;G++){this.selectedColumns[G]=E.selectedColumn[G];this.selectedColumnsBinding[G]=E.selectedBinding[G];if(G>=this.aggregationBlocks.length){this.aggregationBlocks[G]=[];}}if(!this.accordion){this._initAccordion();}else{var H=this.accordion.panel.items.items;var I=this.selectedColumns.length-H.length;var B=this._init_htmlContent();this.selectedColumnsDiv=B;if(I>=0){for(var G=0;G<H.length;G++){this.accordion.setItemTitle(H[G],this.selectedColumns[G].bindingName);this._initAggrBlocks(G,B[G].id);this.accordion.setItemContentEl(H[G],B[G].id);H[G].show();for(var C=0;C<this.aggregationBlocks[G].length;C++){if(this.aggregationBlocks[G][C].isVisible()){this.aggregationBlocks[G][C].show();}}}this.accordion.collapseAll();this.accordion.expandItem(H[0]);var A;for(var G=0;G<I;G++){var D=this.accordion.panel.items.items.length;this._initAggrBlocks(G+D,B[G+D].id);A=new actuate.uiadapter.Panel({title:this.selectedColumns[G+D].bindingName,contentEl:B[G+D].id});this.accordion.panel.add(A.panel);}}else{for(var G=0;G<this.selectedColumns.length;G++){this.accordion.panel.items.items[G].setTitle(this.selectedColumns[G].bindingName);this._initAggrBlocks(G,B[G].id);this.accordion.panel.items.items[G].setContentEl(B[G].id);this.accordion.panel.items.items[G].show();for(var C=0;C<this.aggregationBlocks[G].length;C++){this.aggregationBlocks[G][C].show();}}this.accordion.expandItem(H[0]);var D=this.accordion.panel.items.items.length-1;for(var G=D;G>D-Math.abs(I);G--){this.accordion.panel.items.items[G].hide();for(var C=0;C<this.aggregationBlocks[G].length;C++){this.aggregationBlocks[G][C].hide();}}}}this._afterExpand();},_eh_addAggregationClick:function(E){var D;var B;var G=this.accordion.panel.items.items;for(var C=0;C<G.length;C++){if(G[C].collapsed==false||G[C].isExpanded){D=C;break;}}var H=this._containsDefaultFunction(D);var A=true;for(var C=0;C<this.aggregationBlocks[D].length;C++){var F=this.aggregationBlocks[D][C];if(!F.isVisible()){B=F;A=false;break;}}if(A&&this.aggregationBlocks[D].length<3){B=new actuate.iv.ui.dialog.aggregation.IVAggregationBlock(this,this.selectedColumnsBinding[D]);B.setAggrBlockColumnIndex(D);this.aggregationBlocks[[D]].push(B);var C=this.aggregationBlocks[D].length-1;this.aggregationBlocks[D][C].blockIndex=C;B.render(this.selectedColumnsDiv[D].id);}if(B){B.selectedColumn=this.selectedColumnsBinding[D];B.setData(null);B.setFunctionToDefault(!H);B.show();this.accordion.expandItem(G[D]);}this.adjustSize(true);},deleteAggrBlocks:function(D,C){var A=this._updateAggrBlockArray(C);for(var B=D;B<A.length-1;B++){A[B].copyData(A[B+1]);}A[A.length-1].hide();var E=this.accordion.panel.items.items;this.accordion.expandItem(E[C]);this.adjustSize(true);},_afterExpand:function(){var B;var C=this.accordion.panel.items.items;for(var A=0;A<C.length;A++){if(C[A].collapsed==false){B=A;break;}}this.aggregationBlockNumbersChanged(B);this.adjustSize(true);},_afterCollapse:function(){this.adjustSize();},_containsDefaultFunction:function(C){for(var B=0;B<this.aggregationBlocks[C].length;B++){var A=this.aggregationBlocks[C][B];if(A.isVisible()){var D=A.func;if(D.toUpperCase()==A._getDefaultFunction().toUpperCase()){return true;}}}return false;},isFunctionValueUsed:function(E,D,C){if(E){for(var B=0;B<this.aggregationBlocks[C].length;B++){var A=this.aggregationBlocks[C][B];if(A.blockIndex!=D&&A.func==E){return true;}}}return false;},prepareFunctionValue:function(F,B,E){var B=B;for(var D=0;D<this.aggregationBlocks[E].length;D++){var C=this.aggregationBlocks[E][D];if(C.blockIndex!=F&&C.isVisible()){if(C.func!=""){var A=B.query("value",C.func.toUpperCase()).itemAt(0);B.remove(A);}}}return B;},filterFunctionValue:function(H,G){var D=this.aggregationBlocks[G][H];var B=[];for(var E=0;E<this.aggregationBlocks[G].length;E++){if(this.aggregationBlocks[G][E]){B[E]=this.aggregationBlocks[G][E].func;}}for(var E=0;E<this.aggregationBlocks[G].length;E++){var A=this.aggregationBlocks[G][E];if(A.blockIndex!=H&&A.isVisible()){var I=A.cloneFunctionStore(G);if(D.isVisible()){var F=I.query("value",D.func).itemAt(0);I.remove(F);}for(var C=0;C<this.aggregationBlocks[G].length;C++){if(C!=E&&C!=H&&this.aggregationBlocks[G][C].isVisible()){if(B[C]!=""){var F=I.query("value",B[G][C]).itemAt(0);I.remove(F);}}}A.selectFunction.setStore(I);}}},_filterFunctionAfterSetData:function(){var G=[];for(var F=0;F<this.selectedColumns.length;F++){for(var E=0;E<this.aggregationBlocks[F].length;E++){G[E]=this.aggregationBlocks[F][E].func;}for(E=0;E<this.aggregationBlocks[F].length;E++){var D=this.aggregationBlocks[F][E];if(D.isVisible()){var B=D.cloneFunctionStore(F);for(var C=0;C<this.aggregationBlocks[F].length;C++){if(C!=E&&this.aggregationBlocks[F][C].isVisible()){if(G[C]!=""){var A=B.query("value",G[C]).itemAt(0);B.remove(A);}}}D.selectFunction.setStore(B);}}}},sortFunctionChange:function(E,D){var C=this.aggregationBlocks[D][E];if(C.isVisible()){if(C.selectSort.getValue()=="none"){for(var B=0;B<this.aggregationBlocks[D].length;B++){if(B==E){continue;}var A=this.aggregationBlocks[D][B];if(A&&A.aggrAtGroupLevel==true){A.selectSort.enable();}}}else{for(var B=0;B<this.aggregationBlocks[D].length;B++){if(B==E){continue;}var A=this.aggregationBlocks[D][B];A.selectSort.disable();}}}else{if(C.selectSort.getValue()!="none"){C.selectSort.setValue("none");for(var B=0;B<this.aggregationBlocks[D].length;B++){var A=this.aggregationBlocks[D][B];if(A&&A.aggrAtGroupLevel==true){A.selectSort.enable();}}}}},aggregationBlockNumbersChanged:function(B){if(B===null||B===undefined){return ;}var A=this._getAggrBlockCount(B);if(A<3){this.addAggregationLink.className="iv_dialog_link_enabled";}else{this.addAggregationLink.className="iv_dialog_link_disabled";}},_updateAggrBlockArray:function(D){var A=[];for(var C=0;C<this.aggregationBlocks[D].length;C++){var B=this.aggregationBlocks[D][C];if(B.isVisible()){A.push(B);}}return A;},_getAggrBlockCount:function(C){var D=0;for(var B=0;B<this.aggregationBlocks[C].length;B++){var A=this.aggregationBlocks[C][B];if(A.isVisible()){D++;}}return D;}});
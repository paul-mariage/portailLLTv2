actuate.util.Package.define("actuate.iv.ui.dialog.aggregation");actuate.iv.ui.dialog.aggregation.IVColumnAggregationDialog=actuate.Class.extendClass(actuate.iv.ui.dialog.AbstractIVDialog,{_classname:"actuate.iv.ui.dialog.aggregation.IVColumnAggregationDialog",_width:518,_htmlElements:{"_selectedColumnElement":null,"_add":null,"_blocksContainer":null},_selectControlsArray:null,selectedColumns:[],isPLSEanbled:null,selectedColumn:null,functionStore:null,hasAutoAdjustSize:true,getFunctionList:function(){return new Array({name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.FIRST"),value:"FIRST"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.LAST"),value:"LAST"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.COUNT"),value:"COUNT"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.MAX"),value:"MAX"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.MIN"),value:"MIN"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.COUNTVALUE"),value:"COUNTDISTINCT"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.SUM"),value:"SUM"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.AVERAGE"),value:"AVE"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.MEDIAN"),value:"MEDIAN"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.STDEV"),value:"STDDEV"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.VAR"),value:"VARIANCE"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.MODE"),value:"MODE"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.WEIGHTEDAVERAGE"),value:"WEIGHTEDAVE"},{name:actuate.util.Utility.getLocalizedString("columnAggregationDialog.functionItem.QUARTILE"),value:"QUARTILE"});},initialize:function(){var A=this._getId(this._classname);this._applyHtmlElementsNames(A);actuate.iv.ui.dialog.aggregation.IVColumnAggregationDialog.superclass.initialize.call(this,A);this.functionList=this.getFunctionList();this.aggregationBlocks=new Array();this._selectControlsArray=new Array();this.selectedColumnElement=document.getElementById(this._htmlElements["_selectedColumnElement"]);actuate.iv.utility.ivUtility.addWordWrap(this.selectedColumnElement);this._local_installEventHandlers(A);},_local_installEventHandlers:function(A){this.addAggregationLink=document.getElementById(this._htmlElements["_add"]);this._eh_addAggregationClick_c=actuate.Method.bindAsEventListener(this._eh_addAggregationClick,this);actuate.util.Event.observe(this.addAggregationLink,"click",this._eh_addAggregationClick_c,false);},_localBind:function(A){if(!A){return ;}this.setData(A);},adjustSize:function(A){var B=this._getAggrBlockCount();B=Math.max(B,0);B=Math.min(B,2);if(this.aggregationBlocks[0]){this.aggregationBlocks[0].container.style.height=(214*B)+"px";}actuate.iv.ui.dialog.aggregation.IVColumnAggregationDialog.superclass.adjustSize.apply(this,arguments);},_hide:function(){actuate.iv.ui.dialog.aggregation.IVColumnAggregationDialog.superclass._hide.apply(this,arguments);if(this.aggregationBlocks){for(var B=0;B<this.aggregationBlocks.length;B++){var A=this.aggregationBlocks[B];if(A){A.hide();}}}},_okPress:function(){if(this.isValid()){this._viewer.eventDispatcher.fireEvent(actuate.iv.core.iVEvent.__E_SETCOLUMNAGGREGATION,this._createColumnAggreationRequest());this._cancelPress();this._hide();}else{this._viewer.eventDispatcher.broadcastEvent(actuate.iv.core.iVEvent.__E_WARN,actuate.util.Utility.getLocalizedString("columnAggregationDialog.invalidFunction"));}},_cancelPress:function(){for(var B=0;B<this.aggregationBlocks.length;B++){var A=this.aggregationBlocks[B];A.func="";}},_keyup:function(A){if(A.keyCode==actuate.util.Event.KEY_ESC){this._hide();}},__getHelpTopic:function(){return"iv_aggregation";},isValid:function(){var C=true;for(var B=0;B<this.aggregationBlocks.length;B++){var A=this.aggregationBlocks[B];if(!A.isVisible()){continue;}if(!A.isValid()){return false;}}return C;},_createColumnAggreationRequest:function(){var G=actuate.util.XmlDom.createXMLDom(actuate.util.Constants.soap.NAMESPACE_ACTUATE10,actuate.Constant.tag.Data);var A=actuate.util.XmlDom.createElement(G,actuate.Constant.tag.COLUMNDEFS);G.documentElement.appendChild(A);for(var C=0;C<this.selectedColumns.length;C++){var F=actuate.util.XmlDom.createElement(G,actuate.Constant.tag.ColumnDef);for(var E=0;E<this.aggregationBlocks.length;E++){var B=this.aggregationBlocks[E];if(!B.isVisible()){continue;}var H=B.createAggrElement(G,E);if(H!=null){F.appendChild(H);}}var D=B.createBoundDataColumnNode(G,this.selectedColumns[C]);if(D){F.appendChild(D);}A.appendChild(F);}return G;},setData:function(F){var D=F[actuate.model.Constant.MetadataType.ELEMENT];this.element=D;this.selectedColumns=[];var A=true;var E="";var B="";for(var C=0;C<F.selectedBinding.length;C++){this.selectedColumns[C]=F.selectedBinding[C];B+=F.selectedBinding[C].displayName;B+=" ";actuate.util.XmlDom.setTextContent(this.selectedColumnElement,B);}actuate.util.XmlDom.setTextContent(this.selectedColumnElement,B);this.selectedColumn=this.selectedColumns[0];this._initAggrBlocks(D,this.selectedColumn);this._filterFunctionAfterSetData();this._sortAfterSetData();this.adjustSize();},_initAggrBlocks:function(D,E){if(E){var B=D.aggregations[E.name];this.isPLSEanbled=D.documentModel._metadata.PLSEnabled;if(this.aggregationBlocks.length<1){var A=new actuate.iv.ui.dialog.aggregation.IVAggregationBlock(this,E);this.aggregationBlocks.push(A);var C=this.aggregationBlocks.length-1;this.aggregationBlocks[C].blockIndex=C;A.render(this._htmlElements["_blocksContainer"]);A.setData(null,this.isPLSEanbled);}if(B){for(var C=0;C<this.aggregationBlocks.length;C++){this.aggregationBlocks[C].hide();}for(var C=0;C<B.length;C++){if(this.aggregationBlocks[C]){var A=this.aggregationBlocks[C];A.selectedColumn=this.selectedColumn;A.setData(B[C],this.isPLSEanbled);A.show();}else{var A=new actuate.iv.ui.dialog.aggregation.IVAggregationBlock(this,E);this.aggregationBlocks.push(A);var C=this.aggregationBlocks.length-1;this.aggregationBlocks[C].blockIndex=C;A.render(this._htmlElements["_blocksContainer"]);A.setData(B[C],this.isPLSEanbled);A.show();}}}else{for(var C=0;C<this.aggregationBlocks.length;C++){var A=this.aggregationBlocks[C];A.selectedColumn=this.selectedColumn;A.setData(null,this.isPLSEanbled);if(C>0){A.hide();}else{A.show();}}}}},isFunctionValueUsed:function(D,C){for(var B=0;B<this.aggregationBlocks.length;B++){var A=this.aggregationBlocks[B];if(A.blockIndex!=C&&A.func==D){return true;}}return false;},prepareFunctionValue:function(E,B){var B=B;for(var D=0;D<this.aggregationBlocks.length;D++){var C=this.aggregationBlocks[D];if(C.blockIndex!=E&&C.isVisible()){if(C.func!=""){var A=B.query("value",C.func.toUpperCase()).itemAt(0);B.remove(A);}}}return B;},filterFunctionValue:function(H){var F=this.aggregationBlocks[H];var G=[];for(var E=0;E<this.aggregationBlocks.length;E++){G[E]=this.aggregationBlocks[E].func;}for(var E=0;E<this.aggregationBlocks.length;E++){var D=this.aggregationBlocks[E];if(D.blockIndex!=H&&D.isVisible()){var B=D.cloneFunctionStore();if(F.isVisible()){var A=B.query("value",F.func);if(A&&A.itemAt){A=A.itemAt(0);}B.remove(A);}for(var C=0;C<this.aggregationBlocks.length;C++){if(C!=E&&C!=H&&this.aggregationBlocks[C].isVisible()){if(G[C]!=""){var A=B.query("value",G[C]);if(A&&A.itemAt){A=A.itemAt(0);}B.remove(A);}}}D.selectFunction.setStore(B);}}},_filterFunctionAfterSetData:function(){var F=[];for(var E=0;E<this.aggregationBlocks.length;E++){F[E]=this.aggregationBlocks[E].func;}for(var E=0;E<this.aggregationBlocks.length;E++){var D=this.aggregationBlocks[E];if(D.isVisible()){var B=D.cloneFunctionStore();for(var C=0;C<this.aggregationBlocks.length;C++){if(C!=E&&this.aggregationBlocks[C].isVisible()){if(F[C]!=""){var A=B.query("value",F[C]).itemAt(0);B.remove(A);}}}D.selectFunction.setStore(B);}}},isMultipleSelection:function(){return this.selectedColumns.length>1;},isGroupSorted:function(C){for(var B=0;B<this.aggregationBlocks.length;B++){var A=this.aggregationBlocks[B];if(A.blockIndex!=C){if(A.selectSort.getValue()!="none"){return true;}}}return false;},sortFunctionChange:function(D){var C=this.aggregationBlocks[D];if(C.isVisible()){if(C.selectSort.getValue()=="none"){for(var B=0;B<this.aggregationBlocks.length;B++){if(B==D){continue;}var A=this.aggregationBlocks[B];if(A&&A.aggrAtGroupLevel==true){A.selectSort.enable();}}}else{if(C.aggrAtGroupLevel==false){for(var B=0;B<this.aggregationBlocks.length;B++){if(B==D){continue;}var A=this.aggregationBlocks[B];if(A&&A.aggrAtGroupLevel==true){A.selectSort.enable();}}}else{for(var B=0;B<this.aggregationBlocks.length;B++){if(B==D){continue;}var A=this.aggregationBlocks[B];A.selectSort.disable();}}}}else{if(C.selectSort.getValue()!="none"){C.selectSort.setValue("none");for(var B=0;B<this.aggregationBlocks.length;B++){var A=this.aggregationBlocks[B];if(A&&A.aggrAtGroupLevel==true){A.selectSort.enable();}}}}},_sortAfterSetData:function(){for(var C=0;C<this.aggregationBlocks.length;C++){var B=this.aggregationBlocks[C];if(B&&B.isVisible()){if(B.aggrAtGroupLevel==true&&B.selectSort.getValue()!="none"){B.selectSort.enable();for(var A=0;A<this.aggregationBlocks.length&&A!=C;A++){var D=this.aggregationBlocks[A];if(D&&D.isVisible()){if(D.aggrAtGroupLevel==true){D.selectSort.disable();}}}}}}},_eh_addAggregationClick:function(D){actuate.util.Event.stop(D);var F=this._containsDefaultFunction();var B;var A=true;for(var C=0;C<this.aggregationBlocks.length;C++){var E=this.aggregationBlocks[C];if(!E.isVisible()){B=E;A=false;break;}}if(A&&this.aggregationBlocks.length<3){B=new actuate.iv.ui.dialog.aggregation.IVAggregationBlock(this,this.selectedColumn);this.aggregationBlocks.push(B);var C=this.aggregationBlocks.length-1;this.aggregationBlocks[C].blockIndex=C;B.render(this._htmlElements["_blocksContainer"]);}B.selectedColumn=this.selectedColumn;B.setData(null,this.isPLSEanbled);B.setFunctionToDefault(!F);B.show();this.adjustSize(true);},deleteAggrBlocks:function(B){var A=this._updateAggrBlockArray();for(var C=B;C<A.length-1;C++){A[C].copyData(A[C+1]);}A[A.length-1].hide();this.adjustSize(true);},_containsDefaultFunction:function(){for(var C=0;C<this.aggregationBlocks.length;C++){var B=this.aggregationBlocks[C];if(B.isVisible()){var D=B.func;var E=B.selectFunction.getValue();var A=B.selectFunction.getRecordByValue(E);if(A){if(D==A.data.value){return true;}}}}return false;},aggregationBlockNumbersChanged:function(){var A=this._getAggrBlockCount();if(A<3){this.addAggregationLink.className="iv_dialog_link_enabled";}else{this.addAggregationLink.className="iv_dialog_link_disabled";}this.adjustSize();},_updateAggrBlockArray:function(){var A=[];for(var C=0;C<this.aggregationBlocks.length;C++){var B=this.aggregationBlocks[C];if(B.isVisible()){A.push(B);}}return A;},_getAggrBlockCount:function(){var C=0;for(var B=0;B<this.aggregationBlocks.length;B++){var A=this.aggregationBlocks[B];if(A.isVisible()){C++;}}return C;}});
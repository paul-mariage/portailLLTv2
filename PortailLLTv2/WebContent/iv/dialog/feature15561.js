actuate.util.Package.define("actuate.dialog.impl.helper.flexcomponentbuilder");actuate.dialog.impl.helper.flexcomponentbuilder.FlexComponentDataTab=actuate.Class.extendClass(actuate.dialog.impl.helper.AbstractDataTabDialog,{_classname:"actuate.dialog.impl.helper.flexcomponentbuilder.FlexComponentDataTab",_dataManagerSoap:null,_filterSoap:null,_filter:null,_usedData:null,_isSummaryTable:false,_TEMPLATE_SELECTED_DATA_LIST:'<tpl for="."><div class="actuate-flexcomponent-div" style="width:278px; height: 20px;">'+"<tpl if=\"disabled == 'false'\">"+'<div class="actuate-flexcomponent-columnnameDiv" style="background-color:inherit;width:170px;height: 20px;float:left" title="'+'{columnName}">{shortColumnName}</div>'+"</tpl>"+"<tpl if=\"disabled == 'true'\">"+'<div class="actuate-flexcomponent-columnnameDiv" style="color:gray;background-color:inherit;width:170px;height: 20px;float:left" title="'+'{columnName}">{shortColumnName}</div>'+"</tpl>"+'<div class="actuate-flexcomponent-innerDiv" style="height: 20px;background-color:inherit;float:left">'+"<tpl if=\"disabled == 'false'\">"+'<div style="background-color:inherit;float:left">{aggregation}</div>'+"</tpl>"+"<tpl if=\"disabled == 'true'\">"+'<div style="color:gray;background-color:inherit;float:left">{aggregation}</div>'+"</tpl>"+"<tpl if=\"aggregation != ''\">"+"<tpl if=\"disabled == 'false'\">"+'<img class="actuate-flexcomponent-img" src=\''+actuate.getDefaultIportalUrl()+"iportal/jsapi/actuate/dialog/images/dropdown-arrow.png'/>"+"</tpl>"+"<tpl if=\"disabled == 'true'\">"+'<img class="actuate-flexcomponent-img-disabled" src=\''+actuate.getDefaultIportalUrl()+"iportal/jsapi/actuate/dialog/images/dropdown-arrow.png'/>"+"</tpl>"+"</tpl>"+"</div></div></tpl>",_selectedMeasureStore:null,LEFT_ENABLE_ICON:"iportal/common/images/left-arrow.png",RIGHT_ENABLE_ICON:"iportal/common/images/right-arrow.png",_bindingsMap:null,_TOOLTIP:{UP:actuate.util.Utility.getLocalizedString("tableBuilder.tooltip.up"),DOWN:actuate.util.Utility.getLocalizedString("tableBuilder.tooltip.down"),ADD:actuate.util.Utility.getLocalizedString("tableBuilder.tooltip.add"),REMOVE:actuate.util.Utility.getLocalizedString("tableBuilder.tooltip.remove")},initialize:function(){this.id=this._getId(this._classname);this._title=actuate.util.Utility.getLocalizedString("tableBuilder.data");actuate.dialog.impl.helper.AbstractTabDialog.prototype.initialize.call(this);this.__initDataSourceCombo();this._popupMenuHandler_c=actuate.Method.bind(this._popupMenuHandler,this);this._autoSumCheckbox=actuate.widget.ComponentMgr.get("actuate_dialog_FlexComponentDataTab_autoSummarizeCheckbox");this._currentMeasureLabel=actuate.widget.ComponentMgr.get("actuate_dialog_FlexComponentDataTab_currentMeasureLabel");this._eh_autoSummarizeCheck_c=actuate.Method.bind(this._eh_autoSummarizeCheck,this);this._autoSumCheckbox.registerEventHandler("check",this._eh_autoSummarizeCheck_c);this._numericFunctionList=new Array({name:"Sum",value:"SUM"},{name:"Average",value:"AVG"},{name:"Max",value:"MAX"},{name:"Min",value:"MIN"});this._nonNumericFunctionList=new Array({name:"Count",value:"COUNT"});},__createDataSourceCombo:function(){return actuate.widget.ComponentMgr.get("actuate_dialog_FlexComponentDataTab_dataSetCombo");},_initContent:function(){this._componentArray=[];var G=this;var H={xtype:"fieldset",title:actuate.util.Utility.getLocalizedString("tableBuilder.data"),checkboxToggle:false,collapsible:true,defaults:{border:false,layout:"column",bodyStyle:"padding:0px 0px 0px 0px"},listeners:{collapse:function(){if(G._parentDialog&&G._parentDialog.adjustSize){G._parentDialog.adjustSize();}},expand:function(){if(G._parentDialog&&G._parentDialog.adjustSize){G._parentDialog.adjustSize();}}},items:[{layout:"column",items:[{layout:"form",border:false,items:[{id:"actuate_dialog_FlexComponentDataTab_dataSetCombo",width:448,fieldLabel:actuate.util.Utility.getLocalizedString("tableBuilder.useDataFrom"),xtype:"treecombo",editable:false,forceSelection:true,autoExpand:true,style:"margin-right:3px",valueField:"value",displayField:"title",titleField:"title",icons:this.__dataSourceIcons,sortInfo:{folderSort:true,field:"text",direction:"ASC"},showTooltip:true,store:new actuate.widget.custom.TreeCombo.TreeComboStore(this.__dataSourceComboStore)}]}]}]};this._componentArray.push(H);var B="<img src='"+actuate.getDefaultIportalUrl()+"iportal/common/images/column_select.png'/>";var C="<img src='"+actuate.getDefaultIportalUrl()+"iportal/jsapi/actuate/dialog/images/cube/crosstab_summary.png'/>";var F={xtype:"fieldset",collapsible:true,title:actuate.util.Utility.getLocalizedString("tableBuilder.fields"),layout:"table",layoutConfig:{columns:4},bodyStyle:"padding:1px 0px 0px 0px",listeners:{collapse:function(){if(G._parentDialog&&G._parentDialog.adjustSize){G._parentDialog.adjustSize();}},expand:function(){if(G._parentDialog&&G._parentDialog.adjustSize){G._parentDialog.adjustSize();}}},items:[{colspan:4,id:"actuate_dialog_FlexComponentDataTab_autoSummarizeCheckbox",xtype:"checkbox",checked:true,boxLabel:actuate.util.Utility.getLocalizedString("tableBuilder.summarize")},{colspan:2,xtype:"label",text:actuate.util.Utility.getLocalizedString("tableBuilder.availableData")},{colspan:2,layout:"table",border:false,items:[{html:B,border:false},{xtype:"label",text:actuate.util.Utility.getLocalizedString("tableBuilder.currentColumnSelection")}]},{id:"actuate_dialog_FlexComponentDataTab_tree",rowspan:3},{border:false,items:[{id:"actuate_dialog_FlexComponentDataTab_rightButton"},{id:"actuate_dialog_FlexComponentDataTab_measureleftButton"}]},{id:"actuate_dialog_FlexComponentDataTab_colList"},{border:false,items:[{id:"actuate_dialog_FlexComponentDataTab_upButton"},{id:"actuate_dialog_FlexComponentDataTab_downButton"}]},{xtype:"label",text:""},{colspan:2,layout:"table",border:false,items:[{html:C,border:false},{xtype:"label",id:"actuate_dialog_FlexComponentDataTab_currentMeasureLabel",text:actuate.util.Utility.getLocalizedString("summaryTableBuilder.currentMeasureSelection")}]},{border:false,items:[{id:"actuate_dialog_FlexComponentDataTab_measurerightButton"},{id:"actuate_dialog_FlexComponentDataTab_measureleftButton"}]},{},{border:false,items:[{id:"actuate_dialog_FlexComponentDataTab_measureUpButton"},{id:"actuate_dialog_FlexComponentDataTab_measureDownButton"}]}]};var E=[];var K=new actuate.widget.tree.TreePanel({rowspan:3,autoScroll:true,width:260,height:230,rootVisible:false,containerScroll:true,dataStore:new actuate.widget.tree.TreeStore(E),selModel:new actuate.widget.tree.MultiSelectionModel(),icons:this.__icons});F.items[3]=K;this._rightButton=new actuate.uiadapter.Button({cls:"actuate_table_builder_move_buttons actuate_flex_builder_move_buttons",disabled:true,icon:this.RIGHT_ENABLE_ICON,tooltip:this._TOOLTIP.ADD});F.items[4].items[0]=this._rightButton;this._leftButton=new actuate.uiadapter.Button({cls:"actuate_table_builder_move_buttons actuate_flex_builder_move_buttons",disabled:true,icon:this.LEFT_ENABLE_ICON,tooltip:this._TOOLTIP.REMOVE});F.items[4].items[1]=this._leftButton;var I=[{type:0,icon:actuate.getDefaultIportalUrl()+"iportal/common/images/column_select.png"}];var D=new actuate.widget.tree.TreePanel({autoScroll:true,width:260,height:100,rootVisible:false,containerScroll:true,dataStore:new actuate.widget.tree.TreeStore(E),selModel:new actuate.widget.tree.MultiSelectionModel(),icons:this.__icons});F.items[5]=D;this._upButton=new actuate.uiadapter.Button({cls:"actuate_table_builder_up_down_buttons actuate_flex_builder_up_down_buttons",icon:"iportal/common/images/up-arrow-disabled.png",tooltip:this._TOOLTIP.UP});F.items[6].items[0]=this._upButton;this._downButton=new actuate.uiadapter.Button({cls:"actuate_table_builder_up_down_buttons actuate_flex_builder_up_down_buttons",icon:"iportal/common/images/down-arrow-disabled.png",tooltip:this._TOOLTIP.DOWN});F.items[6].items[1]=this._downButton;this._measureRightButton=new actuate.uiadapter.Button({cls:"actuate_table_builder_move_buttons actuate_flex_builder_move_buttons",disabled:true,icon:this.RIGHT_ENABLE_ICON,tooltip:this._TOOLTIP.ADD});F.items[9].items[0]=this._measureRightButton;this._measureLeftButton=new actuate.uiadapter.Button({cls:"actuate_table_builder_move_buttons actuate_flex_builder_move_buttons",disabled:true,icon:this.LEFT_ENABLE_ICON,tooltip:this._TOOLTIP.REMOVE});F.items[9].items[1]=this._measureLeftButton;this._selectedMeasureStore=new actuate.widget.data.SimpleStore({fields:["value","columnName","aggregation","aggregationValue","index","shortColumnName","disabled"],sortInfo:{field:"index",direction:"ASC"}});var J=new actuate.widget.form.ListBox({store:this._selectedMeasureStore,width:258,height:100,multiSelect:true,tpl:this._TEMPLATE_SELECTED_DATA_LIST,style:"border-color: #7f9db9",disabledClass:"actuate_table_builder_list_disabled",itemSelector:".actuate-flexcomponent-div"});F.items[10]=J;this._measureList=J;this._measureUpButton=new actuate.uiadapter.Button({cls:"actuate_table_builder_up_down_buttons actuate_flex_builder_up_down_buttons",icon:"iportal/common/images/up-arrow-disabled.png",tooltip:this._TOOLTIP.UP});F.items[11].items[0]=this._measureUpButton;this._measureDownButton=new actuate.uiadapter.Button({cls:"actuate_table_builder_up_down_buttons actuate_flex_builder_up_down_buttons",icon:"iportal/common/images/down-arrow-disabled.png",tooltip:this._TOOLTIP.DOWN});F.items[11].items[1]=this._measureDownButton;this._componentArray.push(F);this._itemsTree=K;this._selectedTree=D;this._rightButton.registerEventHandler("click",actuate.Method.bind(this._rightButtonClick,this),false);this._leftButton.registerEventHandler("click",actuate.Method.bind(this._leftButtonClick,this),false);this._measureRightButton.registerEventHandler("click",actuate.Method.bind(this._measureRightButtonClick,this),false);this._measureLeftButton.registerEventHandler("click",actuate.Method.bind(this._measureLeftButtonClick,this),false);this._upButton.registerEventHandler("click",actuate.Method.bind(this._upButtonClick,this),false);this._downButton.registerEventHandler("click",actuate.Method.bind(this._downButtonClick,this),false);this._measureUpButton.registerEventHandler("click",actuate.Method.bind(this._measureUpButtonClick,this),false);this._measureDownButton.registerEventHandler("click",actuate.Method.bind(this._measureDownButtonClick,this),false);this._measureList.registerEventHandler("click",actuate.Method.bind(this._selectedMeasureClick,this),false);var A=actuate.Method.bind(this._eh_onBeforeSelect,this);this._itemsTree.getSelectionModel().registerEventHandler("beforeselect",A);this._itemsTree.getSelectionModel().registerEventHandler("selectionchange",actuate.Method.bind(this._itemsTreeChange,this));this._selectedTree.getSelectionModel().registerEventHandler("selectionchange",actuate.Method.bind(this._selectedTreeChange,this));},_selectedTreeChange:function(B){if(!B||!B.selNodes||B.selNodes.length<=0||!B.selNodes[0].attributes){return ;}var D=this.__getSelectedNodes(this._selectedTree);if(!D||D.length<=0){this._leftButton.disable();this._upButton.setIcon("iportal/common/images/up-arrow-disabled.png");this._downButton.setIcon("iportal/common/images/down-arrow-disabled.png");}else{if(D.length==1&&D[0].disabled){this._leftButton.disable();}else{this._leftButton.enable();}var C=D[0];if(C!=null){if(C.previousSibling==null){this._upButton.setIcon("iportal/common/images/up-arrow-disabled.png");}else{this._upButton.setIcon("iportal/common/images/up-arrow.png");}}var A=D[D.length-1];if(A!=null){if(A.nextSibling==null){this._downButton.setIcon("iportal/common/images/down-arrow-disabled.png");}else{this._downButton.setIcon("iportal/common/images/down-arrow.png");}}}},_itemsTreeChange:function(A){if(!A||!A.selNodes||A.selNodes.length<=0||!A.selNodes[0].attributes){return ;}if(!this._autoSumCheckbox.getValue()){var B=this.__getSelectedNodes(this._itemsTree);if(!B||B.length<=0){this._rightButton.disable();}else{this._rightButton.enable();}return ;}this._measureRightButton.disable();this._rightButton.disable();if(A.selNodes[0].attributes.type=="dimension"||A.selNodes[0].attributes.type=="attribute"||A.selNodes[0].attributes.type==""){this._rightButton.enable();}else{if(A.selNodes[0].attributes.type=="measure"){this._measureRightButton.enable();}}},_selectedMeasureClick:function(D,B,A,C){this._enableDisableMeasureUpDownButtons();var E=actuate.uiadapter.Element.fly(C.getTarget());if(E.hasClass("actuate-flexcomponent-img")){this._popupMenu(A,E.parent());}},_popupMenu:function(A,D){if(!this._aggrMenu){this._aggrMenu=new actuate.widget.menu.Menu({id:"actuate_dialog_FlexComponentDataTab_AggregationPopupMenu"});}var E=A.data.value;var B=this._getDataType(E);this._aggrMenu.removeAll();this._aggrMenu.currentRecord=A;var F="aggr";for(var C=0;C<this._nonNumericFunctionList.length;C++){this._aggrMenu.addMenuItem({id:this._nonNumericFunctionList[C].value,text:this._nonNumericFunctionList[C].name,group:F,handler:this._popupMenuHandler_c});}if(B=="float"||B=="integer"||B=="decimal"||B=="double"){for(var C=0;C<this._numericFunctionList.length;C++){this._aggrMenu.addMenuItem({id:this._numericFunctionList[C].value,text:this._numericFunctionList[C].name,group:F,handler:this._popupMenuHandler_c});}}this._aggrMenu.show(D);},_popupMenuHandler:function(B){var A=this._aggrMenu.currentRecord;A.data.aggregation=B.text;A.data.aggregationValue=B.id;A.commit();},loadData:function(A){this._hasNewDatamart=false;if(A&&A.DataMarts){this._data=A;this.__showAllDataSources();}if(this._data&&this._data.DataMarts&&this._data.DataMarts.length>0){this.__selectDataSource(A.DataSet,"dataset");if(A.ColumnDef){if(!A.DataSet.dataObject){A.DataSet.dataObject=A.DataSet.dataSetName;}this._isSummaryTable=false;if(A.Format!=null&&A.Format.AutoSummarize=="true"){this._isSummaryTable=true;}this._usedData={"dataSet":A.DataSet.dataSourceName+" - "+A.DataSet.dataObject,"columnDefs":A.ColumnDef,"aggregations":A.Aggregations,"summaryTable":this._isSummaryTable};}this.__onSelectDataSource();if(A.Filter){this._filter=A.Filter;}}},__addToDataSourceStore:function(A,B,C){if(B!="cube"){actuate.dialog.impl.helper.flexcomponentbuilder.FlexComponentDataTab.superclass.__addToDataSourceStore.call(this,A,B,C);}},_getFunctionName:function(B){for(var A=0;A<this._numericFunctionList.length;A++){if(this._numericFunctionList[A].value==B){return this._numericFunctionList[A].name;}}for(var A=0;A<this._nonNumericFunctionList.length;A++){if(this._nonNumericFunctionList[A].value==B){return this._nonNumericFunctionList[A].name;}}return null;},_preHide:function(){this._dataManagerMetadata=null;this._clearControls();},_clearControls:function(){this.__dataSourceCombo.clear();this.__dataSourceCombo.setValue("");this._dataManagerSoap=null;this._clearTree(this._itemsTree);this._clearTree(this._selectedTree);this._selectedMeasureStore.removeAll();this._usedData=null;this.__clearFilter();this._autoSumCheckbox.enable();this._bindingsMap=null;this._measureUpButton.setIcon("iportal/common/images/up-arrow-disabled.png");this._measureDownButton.setIcon("iportal/common/images/down-arrow-disabled.png");this._upButton.setIcon("iportal/common/images/up-arrow-disabled.png");this._downButton.setIcon("iportal/common/images/down-arrow-disabled.png");},_clearTree:function(B){B.getSelectionModel().clearSelections();if(B.root){var A;while(A=B.root.childNodes[0]){B.root.removeChild(A);}}},__onSelectDataSource:function(){this.__clearFilter();this._disableUpDownButtons();var A=this.__getSelectedDataSourceInfo();this._measureLeftButton.disable();this._leftButton.disable();this._resetItemsTree();this._showUsedDataBindings();this._clearFilterUI=true;actuate.dialog.impl.helper.flexcomponentbuilder.FlexComponentDataTab.superclass.__onSelectDataSource.call(this);this._measureRightButton.disable();this._rightButton.disable();},_resetItemsTree:function(){var A=this.__dataSourceCombo.getValue();this._clearTree(this._selectedTree);this._selectedMeasureStore.removeAll();this._itemsTree.getStore().removeAll();this.__setTreeStoreValues(this._itemsTree.getStore(),A);this._itemsTree.refresh();this._itemsTree.expandAll();},_disableUpDownButtons:function(){this._upButton.setIcon("iportal/common/images/up-arrow-disabled.png");this._downButton.setIcon("iportal/common/images/down-arrow-disabled.png");this._measureUpButton.setIcon("iportal/common/images/up-arrow-disabled.png");this._measureDownButton.setIcon("iportal/common/images/down-arrow-disabled.png");},_getDataSetColumn:function(D){var A=this.__getSelectedDataSourceInfo();if(A){var C=A[1].columns;for(var B=0;B<C.length;B++){if(C[B].name==D){return C[B];}}}return"";},_getAnalysisType:function(D){var A=this.__getSelectedDataSourceInfo();var C=A[1].columns;for(var B=0;B<C.length;B++){if(C[B].name==D){return C[B].analysis;}}return null;},_getAnalysisColumn:function(D){var A=this.__getSelectedDataSourceInfo();var C=A[1].columns;for(var B=0;B<C.length;B++){if(C[B].name==D){return C[B].analysisColumn;}}return"";},_getDataType:function(D){var A=this.__getSelectedDataSourceInfo();var C=A[1].columns;for(var B=0;B<C.length;B++){if(C[B].name==D){return C[B].dataType;}}},_eh_autoSummarizeCheck:function(){if(this._autoSumCheckbox.getValue()){this._measureList.enable();this._currentMeasureLabel.getEl().dom.style.color="black";this._formTree();if(this._selectedMeasureStore.getCount()>1){this._measureUpButton.setIcon("iportal/common/images/up-arrow.png");this._measureDownButton.setIcon("iportal/common/images/down-arrow-disabled.png");}else{this._measureUpButton.setIcon("iportal/common/images/up-arrow-disabled.png");this._measureDownButton.setIcon("iportal/common/images/down-arrow-disabled.png");}if(this._selectedMeasureStore.getCount()>0){this._measureLeftButton.enable();}if(this._isEmptyTree(this._selectedTree)){this._leftButton.disable();this._rightButton.disable();}else{this._leftButton.enable();}var A=this.__getSelectedNodes(this._itemsTree);if(!A||A.length<=0){this._measureRightButton.disable();this._rightButton.disable();}else{if(A&&A[0].attributes.type=="measure"){this._measureRightButton.enable();this._rightButton.disable();}else{this._measureRightButton.disable();this._rightButton.enable();}}}else{this._measureList.disable();this._currentMeasureLabel.getEl().dom.style.color="gray";this._measureUpButton.setIcon("iportal/common/images/up-arrow-disabled.png");this._measureDownButton.setIcon("iportal/common/images/down-arrow-disabled.png");this._flattenTree();this._addNodesFromMeasureToDimensionList();this._measureLeftButton.disable();this._measureRightButton.disable();this._rightButton.enable();var A=this.__getSelectedNodes(this._itemsTree);if(!A||A.length<=0){this._rightButton.disable();}if(this._isEmptyTree(this._selectedTree)){this._leftButton.disable();}else{if(this._selectedTree.getRootNode().lastChild){this._selectedTree.getRootNode().lastChild.select();}this._leftButton.enable();}}this.__selectionChangedHandler();},_addNodesFromMeasureToDimensionList:function(){var D=this._measureList.store.data.items;this._selectedMeasureStore.removeAll();for(var A=0;A<D.length;A++){var B=this._itemsTree.getNodeById(D[A].data.value);var C={id:B.id,text:B.text.length>25?B.text.substr(0,22)+"...":B.text,index:B.attributes.index,type:B.attributes.type,dateFunction:"",dateFunctionValue:"",title:B.text};this._selectedTree.getRootNode().appendChild(C);}if(this._selectedMeasureStore.getCount()>0){this._measureList.setSelectedIndex(this._selectedMeasureStore.getCount()-1);}},_changeFilterPanel:function(B){if(this._parentDialog._filterPanel){var C={};var A=this.__getSelectedDataSourceInfo();if(A){C.dataObject=[A[1],A[4],A[3]];C.dataObjectSoap=this.createDataSetSoap(A);C.dataMartSoap=this._dataManagerSoap;C.clearFilterUI=this._clearFilterUI;C.target="Table";}if(this._filter){C.Filter=this._filter;}this._parentDialog._filterPanel.loadData(C);}},_showUsedNormalTableDataBindings:function(){this._autoSumCheckbox.setValue(false);var A=this.__getSelectedDataSourceInfo();if(this._usedData!=null&&A&&this._usedData.dataSet==A[0]+" - "+A[1].name){var H=this._usedData.columnDefs["size"];for(var G=0;G<H;G++){this._leftButton.enable();var E=this._usedData.columnDefs[G];var D=E.bindingName;var F=this._getDataSetColumn(D);var B=F.displayName;if(B==null||B==""){B=D;}var C=this._selectedTree.getRootNode().findChild("id",D);if(C==null){C=this._selectedTree.getRootNode().appendChild({id:D,text:B.length>25?B.substr(0,22)+"...":B,index:E.index,type:this._getAnalysisType(D),dateFunction:"",dateFunctionValue:"",title:B});}C.select();if(this._hasDependents(C.id)){C.disable();}}}this._sortSelectedTree();},_showUsedDataBindings:function(){var N=this.__getSelectedDataSourceInfo();if(this._usedData!=null&&!this._isSummaryTable){this._autoSumCheckbox.setValue(false);this._showUsedNormalTableDataBindings();return ;}this._autoSumCheckbox.setValue(true);var I=null;if(this._usedData!=null&&N&&(this._usedData.dataSet==N[0]+" - "+N[1].name)){var Q=this._usedData.columnDefs["size"];for(var H=0;H<Q;H++){this._leftButton.enable();var J=this._usedData.columnDefs[H];var E=J.bindingName;if(E==null){continue;}var P=this._getDataSetColumn(E);var O=P.displayName;if(O==null||O==""){O=E;}var K="";if(this._getAnalysisType(E)!="measure"){var M=this._getAnalysisColumn(E);if(M&&M!=""){var C=this._selectedTree.getRootNode().findChild("id",M);if(C==null){var A=this._getDataSetColumn(M);var L=A.displayName;if(L==null||L==""){L=M;}I=this._selectedTree.getRootNode().appendChild({id:M,text:L.length>25?L.substr(0,22)+"...":L,index:J.index,type:this._getAnalysisType(M),dateFunction:"",dateFunctionValue:"",title:L});}C=this._selectedTree.getRootNode().findChild("id",M);I=C.appendChild({id:E,text:O.length>25?O.substr(0,22)+"...":O,index:J.index,type:this._getAnalysisType(E),dateFunction:"",dateFunctionValue:"",title:O});C.expand(true,false);if(!this._isInColumnDef(this._usedData.columnDefs,M)){C.disable();}else{C.enable();}}else{var C=this._selectedTree.getRootNode().findChild("id",E);if(C==null){I=this._selectedTree.getRootNode().appendChild({id:E,text:O.length>25?O.substr(0,22)+"...":O,index:J.index,type:this._getAnalysisType(E),dateFunction:"",dateFunctionValue:"",title:O});}}}if(I!=null&&this._hasDependents(I.id)){I.disable();}}if(I!=null){I.select();}for(var D in this._usedData.aggregations){this._measureLeftButton.enable();var B=this._usedData.aggregations[D];for(var F=0;F<B.length;F++){var P=this._getDataSetColumn(D);var O=P.displayName;if(O==null||O==""){O=D;}var G="false";if(this._hasDependents(B[F].bindingName)){G="true";}var K=new this._selectedMeasureStore.recordType({columnName:O,value:D,aggregation:this._getFunctionName(B[F].func),aggregationValue:B[F].func,index:B[F].index,shortColumnName:O.length>25?O.substr(0,22)+"...":O,disabled:G});this._selectedMeasureStore.addSorted(K);}}}this._sortSelectedTree();if(this._selectedMeasureStore.getCount()>0){this._measureList.setSelectedIndex(this._selectedMeasureStore.getCount()-1);this._enableDisableMeasureUpDownButtons();}},_hasDependents:function(B){var A=false;for(var C in this._bindingsMap){var D=this._bindingsMap[C];if(D==null){continue;}if(D.aggregateOn!=null&&D.aggregateOn==B){A=this._hasDependents(C);if(A==true){break;}}else{if(C!=B){continue;}}if(D.hasDependents){return true;}}return A;},_isInColumnDef:function(E,C){for(var D in E){var B=this._usedData.columnDefs[D];var A=B.isGrouped?B.groupName:B.bindingName;if(A==null){continue;}if(C==A){return true;}}return false;},_sortSelectedTree:function(){var C=new actuate.widget.tree.TreeSorter(this._selectedTree,{folderSort:true,dir:"asc",registerHandlers:false,sortType:function(D){return D.attributes.index;}});if(this._selectedTree.getRootNode()!=null){C.doSort(this._selectedTree.getRootNode());var A=this._selectedTree.getRootNode().childNodes;for(var B=0;B<A.length;B++){C.doSort(A[B]);}}},_isDateTime:function(B){var A=this._getDataType(B);if(A=="date-time"||A=="date"||A=="time"){return true;}return false;},getDataSelection:function(){var A=this.__getSelectedDataSourceInfo();if(A&&A[1]){return{dataSourceName:A[1].name};}return null;},_upButtonClick:function(){if(this._upButton.getIcon().indexOf("-gray")>=0){return ;}this.__reorderTreeItem(this._selectedTree,true);},_downButtonClick:function(){if(this._downButton.getIcon().indexOf("-gray")>=0){return ;}this.__reorderTreeItem(this._selectedTree,false);},__reorderTreeItem:function(F,I){var K=this.__getSelectedNodes(F);if(!K||K.length<=0){return ;}if(!I){K=K.reverse();}var D=F.getSelectionModel();for(var G=0;G<K.length;G++){var J=K[G];var H=J.parentNode;if(I){var B=J.previousSibling;var C=J.isSelected();if(J&&B){H.insertBefore(J,B);}}else{var E=J.nextSibling;if(J&&E){H.insertBefore(E,J);}}if(C){D.select(J,null,true);}}if(F!=this._selectedTree){return ;}var A=this.__getSelectedNodes(F);if(A.length>0&&A[0].previousSibling==null){this._upButton.setIcon("iportal/common/images/up-arrow-disabled.png");}else{this._upButton.setIcon("iportal/common/images/up-arrow.png");}if(A.length>0&&A[A.length-1].nextSibling==null){this._downButton.setIcon("iportal/common/images/down-arrow-disabled.png");}else{this._downButton.setIcon("iportal/common/images/down-arrow.png");}},_leftButtonClick:function(){var F=this.__getSelectedNodes(this._selectedTree);if(F&&F.length>0){for(var B=0;B<F.length;B++){var D=F[B];if(this._hasDependents(D.id)){continue;}if(D.nextSibling){D.nextSibling.select();}else{if(D.previousSibling){var C=D.previousSibling;if(C.lastChild){C.lastChild.select();}else{C.select();}}else{D.parentNode.select();}}var A=D.parentNode;A.removeChild(D);if(A.disabled==true&&!this._hasDependents(A.id)&&A.childNodes.length==0){var E=A.parentNode.removeChild(A);}}}if(this._isEmptyTree(this._selectedTree)){this._leftButton.disable();}},__getSelectedNodes:function(A){var C=[];var B=A.getSelectionModel().getSelectedNodes();if(B&&B.length>0){C=[].concat(B);}return C;},_moveChildAttributesToTree:function(D,A){for(var B=0;B<D.length;B++){var C=D[B];if(C!=null&&C.disabled){continue;}targetNode=A.appendChild({id:C.id,text:C.text.length>25?C.text.substr(0,22)+"...":C.text,index:C.attributes.index,type:C.attributes.type,dateFunction:"",dateFunctionValue:"",title:C.text});}},_rightButtonClick:function(){var L=this.__getSelectedNodes(this._itemsTree);if(L&&L.length>0){this._leftButton.enable();var C=false;if(L[0]==this._itemsTree.getRootNode().firstChild&&this._itemsTree.getRootNode().firstChild.hasChildNodes()){L=this._itemsTree.getRootNode().firstChild.childNodes;C=true;}for(var F=0;F<L.length;F++){var G=L[F];if(G!=null&&G.disabled){continue;}var D=G.attributes.type;var E=false;var I=false;var M=G;if(this._selectedTree){if(D=="measure"&&this.isSummarize()){continue;}if(D=="attribute"&&this.isSummarize()){var K=G.parentNode;var J=K.attributes.type;if(J&&J=="dimension"){G=K;E=true;}}else{if(D=="dimension"){I=true;}}var H=this._selectedTree.getNodeById(G.id);if(H){if(this._hasDependents(H.id)){continue;}if(M==G){H.enable();}}else{if(this._itemsTree.getRootNode()!=null&&G!=this._itemsTree.getRootNode().firstChild){H=this._selectedTree.getRootNode().appendChild({id:G.id,text:G.text.length>25?G.text.substr(0,22)+"...":G.text,index:G.attributes.index,type:G.attributes.type,dateFunction:"",dateFunctionValue:"",title:G.text});if(G.hasChildNodes()&&C==true){var B=G.childNodes;if(this.isSummarize()){this._moveChildAttributesToTree(B,H);}else{this._moveChildAttributesToTree(B,this._selectedTree.getRootNode());}}if(E){H.disable();}else{H.enable();}}}if(M!=G){var A=this._appendNode(H,M);A.select();if(M.nextSibling){M.nextSibling.select();}else{if(G.nextSibling){G.nextSibling.select();}else{G.parentNode.firstChild.select();}}continue;}else{if(D=="dimension"){}else{this._nodeCopy(G,H,I);if(D=="attribute"){if(M.nextSibling){M.nextSibling.select();}else{if(M.parentNode&&M.parentNode.nextSibling){M.parentNode.nextSibling.select();}else{M.parentNode.firstChild.select();}}if(H){H.select();H.expand(true,false);}continue;}}}if(H){H.select();H.expand(true,false);}}if(G.hasChildNodes()){G.childNodes[0].select();}else{if(G.nextSibling){G.nextSibling.select();}else{G.parentNode.firstChild.select();}}}}},_appendNode:function(C,B){var A=C.findChild("id",B.id);if(A!=null){return A;}A=C.appendChild({id:B.id,text:B.text.length>25?B.text.substr(0,22)+"...":B.text,index:B.attributes.index,type:B.attributes.type,dateFunction:"",dateFunctionValue:"",title:B.text});return A;},_nodeCopy:function(B,E,A){if(!B||!E){return ;}if(B.hasChildNodes()){var F=B.childNodes;for(var D=0;D<F.length;D++){var C=this._appendNode(E,F[D]);if(C&&A){C.disable();}else{C.enable();}}}},_measureUpButtonClick:function(B){actuate.util.Event.stop(B);if(this._measureUpButton.getIcon().indexOf("-gray")>=0){return ;}var A=this._measureList.getSelectedIndex();if(A==0){return ;}this._measureList.swap(A,A-1);this._enableDisableMeasureUpDownButtons();},_enableDisableMeasureUpDownButtons:function(){var A=this._measureList.getSelectedIndexes();if(A.length>0){if(A[0]==0){this._measureUpButton.setIcon("iportal/common/images/up-arrow-disabled.png");}else{this._measureUpButton.setIcon("iportal/common/images/up-arrow.png");}if(A[A.length-1]==this._measureList.getStore().getCount()-1){this._measureDownButton.setIcon("iportal/common/images/down-arrow-disabled.png");}else{this._measureDownButton.setIcon("iportal/common/images/down-arrow.png");}}},_measureDownButtonClick:function(B){actuate.util.Event.stop(B);if(this._measureDownButton.getIcon().indexOf("-gray")>=0){return ;}var A=this._measureList.getSelectedIndex();if(A==this._measureList.getLength()-1){return ;}this._measureList.swap(A,A+1);this._enableDisableMeasureUpDownButtons();},_measureRightButtonClick:function(){var E=this._itemsTree.getSelectionModel().getSelectedNodes();if(E){this._measureLeftButton.enable();for(var A=0;A<E.length;A++){var D=E[A];if(D.childNodes.length==0){if(this._itemsTree.getRootNode()!=null&&this._itemsTree.getRootNode().firstChild==D){return ;}if(D.attributes.type!="measure"){continue;}this._addNodeToMeasureStore(D);if(D.nextSibling){D.nextSibling.select();}else{if(D.previousSibling){D.previousSibling.select();}}}else{var C=0;while(C<D.childNodes.length){var B=D.childNodes[C];this._addNodeToMeasureStore(B);C++;}break;}}this._measureList.setSelectedIndex(this._selectedMeasureStore.getCount()-1);this._enableDisableMeasureUpDownButtons();}},_measureLeftButtonClick:function(){if(this._measureList.getSelectedIndex()==-1){return ;}var A=this._measureList.getSelectedIndexes();var C=this._measureList.getSelectedRecords(true);for(var B=0;B<C.length;B++){if(C[B].data.disabled=="false"){this._selectedMeasureStore.remove(C[B]);}}if(this._selectedMeasureStore.getCount()==0){this._measureLeftButton.disable();}else{var D=A[A.length-1];if(D>=this._selectedMeasureStore.getCount()){this._measureList.setSelectedIndex(this._selectedMeasureStore.getCount()-1);}else{this._measureList.setSelectedIndex(D);}}this._enableDisableMeasureUpDownButtons();},_flattenTree:function(){var C=this._selectedTree.getRootNode();if(C==null){return ;}if(C.hasChildNodes()){var A=this._selectedTree.getRootNode().childNodes;var B=A.splice(0,A.length);this._clearTree(this._selectedTree);for(var D=0;D<B.length;D++){if(B[D].disabled==false){this._selectedTree.getRootNode().appendChild(B[D]);}else{this._selectedTree.getRootNode().removeChild(B[D]);}if(B[D].hasChildNodes()){while(B[D].hasChildNodes()){var E=B[D].childNodes[0];if(E.disabled==false){this._selectedTree.getRootNode().appendChild(E);}}}}}},_addNodeToMeasureStore:function(D){var B=this._getDataType(D.id);var C="false";if(B=="float"||B=="integer"||B=="decimal"||B=="double"){var A=new this._selectedMeasureStore.recordType({columnName:D.text,value:D.id,aggregation:this._getFunctionName("SUM"),aggregationValue:"SUM",index:0,shortColumnName:D.text.length>25?D.text.substr(0,22)+"...":D.text,disabled:C});this._selectedMeasureStore.add(A);}else{var A=new this._selectedMeasureStore.recordType({columnName:D.text,value:D.id,aggregation:this._getFunctionName("COUNT"),aggregationValue:"COUNT",index:0,shortColumnName:D.text.length>25?D.text.substr(0,22)+"...":D.text,disabled:C});this._selectedMeasureStore.add(A);}},_formTree:function(){var D=this._selectedTree.getRootNode();if(D==null){return ;}if(D.hasChildNodes()){var B=D.childNodes;var F=0;while(F<D.childNodes.length){var I=D.childNodes[F];if(this._getAnalysisType(I.id)=="attribute"){var H=this._getAnalysisColumn(I.id);if(H&&H!=""){var C=this._selectedTree.getRootNode().findChild("id",H);if(C==null){var A=this._getDataSetColumn(H);var G=A.displayName;if(G==null||G==""){G=H;}C=this._selectedTree.getRootNode().appendChild({id:H,text:G.length>25?G.substr(0,22)+"...":G,index:A.index,type:this._getAnalysisType(H),dateFunction:"",dateFunctionValue:"",title:G});C.disable();}C=this._selectedTree.getRootNode().findChild("id",H);C.appendChild(I);}else{F++;}}else{F++;}}this._selectedTree.getRootNode().expandChildNodes(true);var E=D.childNodes;var F=0;while(F<D.childNodes.length){if(E[F].attributes.type=="measure"){this._addNodeToMeasureStore(E[F]);if(E[F].nextSibling){E[F].nextSibling.select();}else{if(E[F].previousSibling){E[F].previousSibling.select();}}D.removeChild(E[F]);}else{F++;}}this._measureList.setSelectedIndex(this._selectedMeasureStore.getCount()-1);if(this._selectedTree.getRootNode().lastChild){this._selectedTree.getRootNode().lastChild.select();if(this._selectedTree.getRootNode().lastChild.hasChildNodes()){this._selectedTree.getRootNode().lastChild.lastChild.select();}}}},createDataSetSoap:function(){var G=actuate.util.XmlDom.createXMLDom(actuate.util.Constants.soap.NAMESPACE_ACTUATE10,actuate.Constant.tag.Data);var H=this.__getSelectedDataSourceInfo();var K=H[1].name;var E=H[0];if(E==null){E="";}var I=H[2];var F=actuate.util.XmlDom.createElement(G,"DataSetDef");var C=actuate.util.XmlDom.createElement(G,"Name");var B=actuate.util.XmlDom.createElement(G,"DataSource");var N=actuate.util.XmlDom.createElement(G,"DisplayName");var J=actuate.util.XmlDom.createElement(G,"DataMartName");var D=G.createTextNode(K);C.appendChild(D);F.appendChild(C);D=G.createTextNode(E);N.appendChild(D);B.appendChild(N);D=G.createTextNode(I);J.appendChild(D);B.appendChild(J);var M=H[4];if(M){var A=(M.toLowerCase()=="data")?actuate.dialog.impl.constant.DataMartAccessType.LATEST:actuate.dialog.impl.constant.DataMartAccessType.TRANSIENT;var L=actuate.util.XmlDom.createElement(G,"Type");L.appendChild(G.createTextNode(A));B.appendChild(L);}F.appendChild(B);return F;},createSoapNode:function(K,G){if(G){if(!this._autoSumCheckbox.getValue()){this._createTableSoapNode(K,G);return ;}var A=actuate.util.XmlDom.createElement(G,"ColumnDefs");var g=this._selectedTree.getRootNode();if(g.hasChildNodes()){var R=0;var h=g.childNodes;for(var b=0;b<h.length;b++){var f=h[b];var M=actuate.util.XmlDom.createElement(G,"ColumnDef");var C=actuate.util.XmlDom.createElement(G,"BoundDataColumn");var c=actuate.util.XmlDom.createElement(G,"Name");var W=f.id;if(f.disabled==false||this._hasDependents(W)){var k=G.createTextNode(W);c.appendChild(k);C.appendChild(c);if(f.attributes.dateFunctionValue!=""){var B=actuate.util.XmlDom.createElement(G,"Pattern");var d=G.createTextNode(f.attributes.dateFunctionValue);B.appendChild(d);C.appendChild(B);}M.appendChild(C);A.appendChild(M);}else{var k=G.createTextNode(W);c.appendChild(k);C.appendChild(c);var B=actuate.util.XmlDom.createElement(G,"Pattern");var d=G.createTextNode("disabled");B.appendChild(d);C.appendChild(B);M.appendChild(C);A.appendChild(M);}if(f.hasChildNodes){var O=f.childNodes;for(var a=0;a<O.length;a++){var N=O[a];if(N.disabled==false||this._hasDependents(N.id)){M=actuate.util.XmlDom.createElement(G,"ColumnDef");C=actuate.util.XmlDom.createElement(G,"BoundDataColumn");c=actuate.util.XmlDom.createElement(G,"Name");W=N.id;var k=G.createTextNode(W);c.appendChild(k);C.appendChild(c);if(N.attributes.dateFunctionValue!=""){var B=actuate.util.XmlDom.createElement(G,"Pattern");var d=G.createTextNode(N.attributes.dateFunctionValue);B.appendChild(d);C.appendChild(B);}M.appendChild(C);A.appendChild(M);}}}}}var T=this._selectedMeasureStore.data.items;for(var b=0;b<T.length;b++){var F=T[b].data;var M=actuate.util.XmlDom.createElement(G,"ColumnDef");var C=actuate.util.XmlDom.createElement(G,"BoundDataColumn");var c=actuate.util.XmlDom.createElement(G,"Name");var W=F.value;var k=G.createTextNode(W);c.appendChild(k);C.appendChild(c);if(F.aggregationValue==null||F.aggregationValue==""){var Z=actuate.util.XmlDom.createElement(G,actuate.Constant.tag.BoundDataColumnExpression);C.appendChild(Z);var L=G.createTextNode(this._getComputedColumnExpression(W));Z.appendChild(L);}M.appendChild(C);var P=actuate.util.XmlDom.createElement(G,"Aggregate");var J=actuate.util.XmlDom.createElement(G,"Func");var I=G.createTextNode(F.aggregationValue);J.appendChild(I);P.appendChild(J);var S=actuate.util.XmlDom.createElement(G,"Label");var V=G.createTextNode(F.aggregation);S.appendChild(V);P.appendChild(S);M.appendChild(P);A.appendChild(M);}G.documentElement.appendChild(A);var Y=this.createDataSetSoap();G.documentElement.appendChild(Y);this.__addFilterSoap(G.documentElement);if(this._dataManagerSoap!=null){var X=this._dataManagerSoap.childNodes[0].data;var E=X.substr(0,X.length-1)+",";var U=G.createTextNode(E);K.appendChild(U);}var D=actuate.util.Json;var e="AutoSummarize:";if(K.childNodes.length==0){e="{AutoSummarize:";}var Q={};Q.value="true";e+=D.makeMap(Q);var H=G.createTextNode(e);K.appendChild(H);}},_createTableSoapNode:function(H,F){if(F){var B=actuate.util.XmlDom.createElement(F,"BoundDataColumnList");var X=this._selectedTree.getRootNode();if(X.hasChildNodes()){var M=0;var Y=X.childNodes;for(var T=0;T<Y.length;T++){var W=Y[T];if(W.disabled&&!this._hasDependents(W.id)){continue;}var C=actuate.util.XmlDom.createElement(F,"BoundDataColumn");var U=actuate.util.XmlDom.createElement(F,"Name");var O=W.id;var a=F.createTextNode(O);U.appendChild(a);C.appendChild(U);B.appendChild(C);if(W.hasChildNodes){var J=W.childNodes;for(var S=0;S<J.length;S++){var I=J[S];if(I.disabled==false||this._hasDependents(I.id)){C=actuate.util.XmlDom.createElement(F,"BoundDataColumn");U=actuate.util.XmlDom.createElement(F,"Name");O=I.id;a=F.createTextNode(O);U.appendChild(a);C.appendChild(U);B.appendChild(C);}}}}}F.documentElement.appendChild(B);var P=this.__getSelectedDataSourceInfo();var Z=P[1].name;var A=P[0];var K=P[2];var R=this.createDataSetSoap();F.documentElement.appendChild(R);this.__addFilterSoap(F.documentElement);if(this._dataManagerSoap!=null){var Q=this._dataManagerSoap.childNodes[0].data;var E=Q.substr(0,Q.length-1)+",";var N=F.createTextNode(E);H.appendChild(N);}var D=actuate.util.Json;var V="AutoSummarize:";if(H.childNodes.length==0){V="{AutoSummarize:";}var L={};L.value="false";V+=D.makeMap(L);var G=F.createTextNode(V);H.appendChild(G);}},isSummarize:function(){return this._autoSumCheckbox.getValue()?true:false;},_isEmptyTree:function(A){if(A.getRootNode()==null||A.getRootNode().hasChildNodes()==false){return true;}return false;},validate:function(){var A=this._isDataSetSelected();if(!A){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("tableBuilder.alertTitle"),msg:actuate.util.Utility.getLocalizedString("common.dataTab.noDataSourceError"),buttons:actuate.widget.MessageBox.OK});return false;}if(this.isSummarize()&&this._measureList.getStore().getCount()<=0&&this._isEmptyTree(this._selectedTree)){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("tableBuilder.alertTitle"),msg:actuate.util.Utility.getLocalizedString("tableBuilder.summaryErrorMessage"),buttons:actuate.widget.MessageBox.OK});return false;}else{if(!this.isSummarize()&&this._isEmptyTree(this._selectedTree)){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("tableBuilder.alertTitle"),msg:actuate.util.Utility.getLocalizedString("tableBuilder.tableErrorMessage"),buttons:actuate.widget.MessageBox.OK});return false;}}return true;},__addDataIntoTreeStore:function(B,A){if(A&&B&&B.dataType!="blob"){B.title=this._getTooltip(B);A.add(B);}},_getType:function(B){if(!B){return ;}var A=B.type;if(B.levels&&B.shared){A="sharedDimension";}else{if(B.analysis=="attribute"&&B.analysisColumn==""){A="attribute";}else{if(B.analysis=="measure"){A="measure";}else{if(B.analysis=="dimension"){A="dimension";}}}}return A;},_eh_onBeforeSelect:function(A,B){if(B&&B.attributes&&B.attributes.type){switch(B.attributes.type){case"sharedDimension":case"category":return false;default:return true;}}return true;},_onTreeNodeSelect:function(B,C){if(B&&this._eh_onBeforeSelect(this,B)){if(B.ownerTree){var A=B.ownerTree.getSelectionModel();if(A){A.select(B,C,C.ctrlKey);}}}}});
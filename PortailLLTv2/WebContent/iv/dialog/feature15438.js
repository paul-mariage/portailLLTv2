actuate.util.Package.define("actuate.dialog.impl.helper.gadgetbuilder");actuate.dialog.impl.helper.gadgetbuilder.BulletDataTab=actuate.Class.extendClass(actuate.dialog.impl.helper.AbstractDataTabDialog,{_classname:"actuate.dialog.impl.helper.gadgetbuilder.BulletDataTab",_selectedIid:null,initialize:function(){this.id=this._getId(this._classname);this._title=actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.data");actuate.dialog.impl.helper.AbstractDataTabDialog.prototype.initialize.call(this);this.__initDataSourceCombo();this._valueDefinitionCombo=actuate.widget.ComponentMgr.get(this.id+"_valuedefinitioncombo");this._agregateExpression=actuate.widget.ComponentMgr.get(this.id+"_agregateExpression");this._hyperlinkCheckbox=actuate.widget.ComponentMgr.get(this.id+"_hyperlinkCheckbox");this._installEventHandlers();this._initializeControlStatus();},_initializeControlStatus:function(){this._validateControlArray=[];this._validateControlArray.push(this._valueDefinitionCombo);},__createDataSourceCombo:function(){return actuate.widget.ComponentMgr.get(this.id+"_datasetcombo");},_initContent:function(){this._aggrNumStore=[["",""],["Sum",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Sum")],["Average",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Average")],["Count",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Count")],["DistinctCount",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.DistinctCount")],["Min",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Min")],["Max",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Max")],["First",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.First")],["Last",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Last")]],this._aggrStringStore=[["",""],["Count",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Count")],["DistinctCount",actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.DistinctCount")]],this._componentArray=[];var A=this;this._valueDefinitionStore=new actuate.widget.data.SimpleStore({fields:["valueDefinitionValue","valueDefinitionText","title","valueDefinitionType","hasAction"]});var C={xtype:"fieldset",collapsible:true,title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.data"),checkboxToggle:false,defaults:{border:false,layout:"column",bodyStyle:"padding:2px 4px 2px 10px"},cls:"actuate-widget-panle-zero-margin-top",listeners:{collapse:function(){if(A._parentDialog&&A._parentDialog.adjustSize){A._parentDialog.adjustSize();}},expand:function(){if(A._parentDialog&&A._parentDialog.adjustSize){A._parentDialog.adjustSize();}}},items:[{layout:"column",items:[{layout:"form",border:false,labelWidth:112,items:[{id:this.id+"_datasetcombo",width:315,fieldLabel:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.useDataFrom"),xtype:"treecombo",forceSelection:true,autoExpand:true,style:"margin-right:3px",editable:false,valueField:"value",displayField:"title",titleField:"title",icons:this.__dataSourceIcons,sortInfo:{folderSort:true,field:"text",direction:"ASC"},showTooltip:true,store:new actuate.widget.custom.TreeCombo.TreeComboStore(this.__dataSourceComboStore)}]}]},{items:[{id:this.id+"_hyperlinkCheckbox",xtype:"checkbox",checked:true,boxLabel:actuate.util.Utility.getLocalizedString("common.dataTab.useHyperlink")}]}]};var B={xtype:"fieldset",collapsible:true,autoHeight:true,title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Value"),checkboxToggle:false,defaults:{border:false,header:false,layout:"column",bodyStyle:"padding:2px 4px 2px 10px"},listeners:{collapse:function(){if(A._parentDialog&&A._parentDialog.adjustSize){A._parentDialog.adjustSize();}},expand:function(){if(A._parentDialog&&A._parentDialog.adjustSize){A._parentDialog.adjustSize();}}},items:[{items:[{columnWidth:0.1,xtype:"label",style:"height:1px"},{columnWidth:0.2,xtype:"label",style:"height:1px",text:""},{columnWidth:0.3,xtype:"label",text:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.dataColumns")},{columnWidth:0.02,xtype:"label",style:"height:1px"},{columnWidth:0.3,xtype:"label",text:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.aggregationExpression")}]},{items:[{columnWidth:0.26,xtype:"label",text:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.selectValue")},{id:this.id+"_valuedefinitioncombo",columnWidth:0.33,viewWidth:250,xtype:"treecombo",editable:false,forceSelection:true,valueField:"valueDefinitionValue",displayField:"valueDefinitionText",titleField:"title",autoExpand:true,showTooltip:true,icons:this.__icons,store:new actuate.widget.custom.TreeCombo.TreeComboStore(this._valueDefinitionStore),validator:function(F){var G=actuate.widget.ComponentMgr.get(A.id+"_valuedefinitioncombo");var E=G.getSelectedIndex();var D=G.getValueAt(E);return D?A._valiateValueDefRecord(D):false;}},{columnWidth:0.03,xtype:"label",style:"height:1px"},{columnWidth:0.33,xtype:"combo",forceSelection:false,value:"",editable:false,id:this.id+"_agregateExpression",store:this._aggrNumStore,listeners:{select:function(I,H){var F=actuate.widget.ComponentMgr.get(A.id+"_valuedefinitioncombo");if(H.data.value=="Count"||H.data.value=="DistinctCount"){F.clearInvalid();}var G=null;var E=F.getSelectedIndex();var D=F.getValueAt(E);if(D){G=D.valueDefinitionText;}if(!actuate.util.Utility.isEmpty(G,false)){A._valiateValueDefRecord(D);}}}}]}]};this._componentArray.push(C);this._componentArray.push(B);},validate:function(){var A=this._isDataCubeSelected();var B=this._isDataSetSelected();if(!(A||B)){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.alertTitle"),msg:actuate.util.Utility.getLocalizedString("common.dataTab.noDataSourceError"),buttons:actuate.widget.MessageBox.OK});return false;}if(!this._getTreeComboValue(this._valueDefinitionCombo)){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.alertTitle"),msg:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.noValueDefError"),buttons:actuate.widget.MessageBox.OK});return false;}if(!this._valueDefinitionCombo.isValid()){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.alertTitle"),msg:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.valueDef.numericTypeNotMatch"),buttons:actuate.widget.MessageBox.OK});return false;}return true;},_installEventHandlers:function(){var A=actuate.Method.bind(this._eh_datasetComboChange,this);var B=actuate.Method.bind(this._eh_onBeforeSelect,this);this.__dataSourceCombo.registerEventHandler("change",A);this._valueDefinitionCombo.registerEventHandler("beforeselect",B);},loadData:function(B){this._hasNewDatamart=false;if(B.Element&&B.Element.iid){this._selectedIid=B.Element.iid;}else{this._selectedIid=null;}if(B.DataMarts){this._data=B;this._clearControls();this.__showAllDataSources();this.__onSelectDataSource();}if(B.Filter){this._filter=B.Filter;}if(B.DataSet&&B.DataSet.dataSourceName){this.__selectDataSource(B.DataSet,"dataset");this.__onSelectDataSource();}else{if(B.Cube&&B.Cube.dataSourceName){this.__selectDataSource(B.Cube,"cube");this.__onSelectDataSource();}}if(B.ValueDefinitions){for(var A in B.ValueDefinitions){if(A){this._agregateExpression.setValue(B.ValueDefinitions[A].Aggregate);this.__setTreeComboValue(this._valueDefinitionCombo,B.ValueDefinitions[A].Query);}}}var C=null;if(B.Element!=null&&B.Element.copyHyperlink!=null){C=B.Element.copyHyperlink=="true"?true:false;}if(C==true){this._hyperlinkCheckbox.setValue(true);}else{if(C==false){this._hyperlinkCheckbox.setValue(false);}}},_changeFilterPanel:function(B){if(this._parentDialog._filterPanel){var C={};var A=this.__getSelectedDataSourceInfo();if(A){C.dataObject=[A[1],A[4],A[3]];C.dataObjectSoap=this.createDataSetSoap(true);C.dataMartSoap=this._dataManagerSoap;C.clearFilterUI=this._clearFilterUI;C.target="FlashGadgets";}if(this._filter){C.Filter=this._filter;}this._parentDialog._filterPanel.loadData(C);}},__onSelectDataSource:function(C){if(C){this.__clearFilter();}var A=this.__getSelectedDataSourceInfo();this._agregateExpression.setSelectedIndex(0);var B=A?A[1].columns:[];if(B&&B.length>0){this._agregateExpression.enable();}var D=A?A[1].measures:[];if(D){this._agregateExpression.disable();}this._resetAllTreeCombo();actuate.dialog.impl.helper.gadgetbuilder.BulletDataTab.superclass.__onSelectDataSource.call(this);},_resetAllTreeCombo:function(){var B=this.__dataSourceCombo.getValue();var A={id:"none",strong:true,value:"",text:""};this._valueDefinitionStore.removeAll();this.__addDataIntoTreeStore(A,this._valueDefinitionStore);this.__setTreeStoreValues(this._valueDefinitionStore,B,["category","column","measure"]);if(this._isDataModelSelected()){this._valueDefinitionCombo.expandDeep=1;}else{this._valueDefinitionCombo.expandDeep=null;}this._valueDefinitionCombo.refresh();this._valueDefinitionCombo.setValueById("none");},_eh_datasetComboChange:function(){this.__selectionChangedHandler();},_preHide:function(){this._hasNewDatamart=false;this._clearControls();this.hidden=true;},_clearControls:function(){this.__dataSourceCombo.clear();this.__dataSourceCombo.setValue("");this._valueDefinitionCombo.clear();this._valueDefinitionCombo.setValueById("none");this._agregateExpression.setValue("");actuate.widget.ComponentMgr.get(this.id+"_hyperlinkCheckbox").enable();actuate.widget.ComponentMgr.get(this.id+"_hyperlinkCheckbox").setValue(true);this._selectedIid=null;this.__clearFilter();this._filter=null;},getDataSelection:function(){var A=this.__getSelectedDataSourceInfo();if(A&&A[1]){return{dataSourceName:A[1].name};}return null;},createDataSetSoap:function(I){var H=actuate.util.XmlDom.createXMLDom(actuate.util.Constants.soap.NAMESPACE_ACTUATE10,actuate.Constant.tag.Data);if(this.__dataSourceComboStore){var J=this.__getSelectedDataSourceInfo();var M=J[1].name;var F=J[0];if(F==null||F==undefined){F="";}var K=J[2];if(J[1].dimensions){if(I==true){G=actuate.util.XmlDom.createElement(H,"Cube");}else{G=actuate.util.XmlDom.createElement(H,"CubeDef");}var C=actuate.util.XmlDom.createElement(H,"Name");var D=H.createTextNode(M);C.appendChild(D);G.appendChild(C);}else{var G=actuate.util.XmlDom.createElement(H,"DataSetDef");var C=actuate.util.XmlDom.createElement(H,"Name");var D=H.createTextNode(M);C.appendChild(D);G.appendChild(C);}var B=actuate.util.XmlDom.createElement(H,"DataSource");var P=J[4];if(P){var A=(P.toLowerCase()=="data")?actuate.dialog.impl.constant.DataMartAccessType.LATEST:actuate.dialog.impl.constant.DataMartAccessType.TRANSIENT;var N=actuate.util.XmlDom.createElement(H,"Type");N.appendChild(H.createTextNode(A));B.appendChild(N);}if(F){var O=actuate.util.XmlDom.createElement(H,"DisplayName");O.appendChild(H.createTextNode(F));B.appendChild(O);}var L=actuate.util.XmlDom.createElement(H,"DataMartName");D=H.createTextNode(K);L.appendChild(D);B.appendChild(L);G.appendChild(B);return G;}else{var E=this.__getSelectedDataSourceInfo();var M=E?E.name:"";var F="";var G=actuate.util.XmlDom.createElement(H,"DataSetDef");var C=actuate.util.XmlDom.createElement(H,"Name");var D=H.createTextNode(M);C.appendChild(D);G.appendChild(C);var B=actuate.util.XmlDom.createElement(H,"DataSource");var O=actuate.util.XmlDom.createElement(H,"DisplayName");D=H.createTextNode(F);O.appendChild(D);B.appendChild(O);G.appendChild(B);return G;}return null;},createSoapNode:function(H,E){if(this._selectedIid){E.documentElement.setAttribute("iid",this._selectedIid);}var P=this.createDataSetSoap();H.appendChild(P);var G=actuate.util.XmlDom.createElement(E,actuate.Constant.tag.Query);var Q=actuate.util.XmlDom.createElement(E,"DataField");var T=this._getTreeComboValue(this._valueDefinitionCombo);var L=E.createTextNode(T);Q.appendChild(L);G.appendChild(Q);var I=this._valueDefinitionCombo.getValue();if(I){var N=actuate.util.XmlDom.createElement(E,"DataType");var B=I.valueDefinitionType;var U=E.createTextNode(B);N.appendChild(U);G.appendChild(N);}if(!this._agregateExpression.disabled&&this._agregateExpression.getValue()!=null&&this._agregateExpression.getValue().length>0){var A=actuate.util.XmlDom.createElement(E,"Aggregate");var J=actuate.util.XmlDom.createElement(E,"Func");var V=E.createTextNode(this._agregateExpression.getValue());J.appendChild(V);A.appendChild(J);G.appendChild(A);}H.appendChild(G);this.__addFilterSoap(E.documentElement);var S=actuate.util.XmlDom.createElement(E,actuate.Constant.tag.Json);E.documentElement.appendChild(S);if(this._dataManagerSoap!=null){var O=this._dataManagerSoap.childNodes[0].data;var D=O.substr(0,O.length-1);this._hyperlinkCheckbox.disabled==true?D:D+=",";var M=E.createTextNode(D);S.appendChild(M);}if(this._hyperlinkCheckbox.disabled==false){var C=actuate.util.Json;var R="UseHyperlink:";if(S.childNodes.length==0){R="{UseHyperlink:";}var K={};K.value=this._hyperlinkCheckbox.getValue().toString();R+=C.makeMap(K)+"}";var F=E.createTextNode(R);S.appendChild(F);}else{var R=null;if(S.childNodes.length!=0){R="}";}else{R="{}";}var F=E.createTextNode(R);S.appendChild(F);}},__addDataIntoTreeStore:function(C,A){if(A&&C&&!(C.value&&C.value.dataType=="blob")){if(A==this._valueDefinitionStore){var B=C.value;if(B&&B.type=="column"&&this._isSummaryTable&&B.isDimension){return ;}}C.valueDefinitionValue=C;C.valueDefinitionText=C.text;C.valueDefinitionType=this._getDataType(C);C.title=this._getTooltip(C);C.dimension=this._getDimension(C);C.hasAction=this._hasAction(C);C.isDimension=this._isDimension(C);C.disabled=this._isDisabled(C,A);A.add(new A.recordType(C,C.id));}},_isDisabled:function(B,A){if(actuate.dialog.impl.helper.gadgetbuilder.BulletDataTab.superclass._isDisabled.apply(this,arguments)){return true;}if(this._isSummaryTable&&B.type=="column"){if(A==this._valueDefinitionStore){return B.isDimension;}}return false;},_getTreeComboValueByRecord:function(B){var A;if(B){A=B.value;}if(B&&B.value&&B.value.type){var D=B.value;switch(D.type){case"attribute":var E=D.fullName;if(E){E=E.replace(/\"/g,'\\"');A='row["'+E+'"]';}break;case"column":var C=D.name;if(C){C=C.replace(/\"/g,'\\"');A='row["'+C+'"]';}break;case"measure":if(D.dataType!="blob"){A='data["'+D.groupName+"/"+D.name+'"]';}break;default:A=D.name;break;}}return A;},_eh_onBeforeSelect:function(B,A){if(A&&A.data&&A.data.valueDefinitionValue){return actuate.dialog.impl.helper.gadgetbuilder.BulletDataTab.superclass._eh_onBeforeSelect.call(this,B,A.data.valueDefinitionValue.node);}return true;},_valiateValueDefRecord:function(D){var C=false;var B=actuate.widget.ComponentMgr.get(this.id+"_valuedefinitioncombo");if(D){var A=D.valueDefinitionType;if(A=="integer"||A=="decimal"||A=="float"){C=true;var F=actuate.widget.ComponentMgr.get(this.id+"_agregateExpression");F.setStore(this._aggrNumStore);}else{var F=actuate.widget.ComponentMgr.get(this.id+"_agregateExpression");F.setStore(this._aggrStringStore);if(F.getValue()=="Count"||F.getValue()=="DistinctCount"){C=true;}else{C=false;var E=actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.valueDef.numericTypeNotMatch");B.markInvalid(E);return E;}}}return C;},__supportAttributes:function(A){return false;}});
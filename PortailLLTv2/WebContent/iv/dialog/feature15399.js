actuate.util.Package.define("actuate.dialog.impl.helper");actuate.dialog.impl.helper.CalculationDialog=actuate.Class.extendClass(actuate.dialog.impl.helper.BaseDialog,{_classname:"actuate.dialog.CalculationDialog",__cls:"calculation_dialog",ADVANCED:"Advanced...",MAX_ARGUMENTS_COUNT:3,REFRESH_ALL:undefined,CATEGORY_CHANGED:"CategoryChanged",FUNCTION_CHANGED:"FunctionChanged",__preventEnterKey:true,_VALID_NAME:0,_DUPLICATE_NAME:1,_INVALID_NAME_FORMAT:2,_width:460,_labelTextField:undefined,_categoryComboBox:undefined,_functionListBox:undefined,_functionSyntaxLabel:undefined,_descriptionLabel:undefined,_examplesPanel:undefined,_expressionLabel:undefined,_expressionTextArea:undefined,_argumentLabels:[],_argumentFields:[],_labelTextFieldID:null,_categoryComboBoxID:null,_functionListBoxID:null,_validateLabelID:null,_operatorsID:"calculation_dialog_operators",_functionsID:"calculation_dialog_functions",_argumentFieldID:[],resultlist:null,hintDiv:null,wordRE:/\S+/,whiteSpaceRE:/\S/,functionBreakRE:/\s+|\+|\*|-|\/|%|\^|&|=|<|>|\(|,/,validNameCharsRE:/[^a-zA-Z0-9_ ]/,validFirstNameCharRE:/[^a-zA-Z]/,stripLeadingRE:/^\s+/g,stripTrailingRE:/\s+$/g,__initComponents:function(){actuate.dialog.impl.helper.CalculationDialog.superclass.__initComponents.apply(this,arguments);this.setTitle(actuate.util.Utility.getLocalizedString("calculationDialog.titleText.New"));this.ADVANCED=actuate.util.Utility.getLocalizedString("calculationDialog.advanced");var A=new actuate.widget.panel.Panel({layout:new actuate.widget.panel.layout.TableLayout({columns:2}),border:false});var D=actuate.util.Utility.getLocalizedString("calculationDialog.columnLabelText");var C=actuate.util.Utility.getLocalizedString("calculationDialog.categoryText");var I=actuate.util.Utility.getLocalizedString("calculationDialog.functionText");var J=actuate.util.Utility.getLocalizedString("calculationDialog.expressionText");var E=new actuate.widget.form.Label({text:D,cellCls:"calculation_dialog_label"});var B=new actuate.widget.form.Label({text:C,cellCls:"calculation_dialog_label"});var F=new actuate.widget.form.Label({text:I,cellCls:"calculation_dialog_padding_top calculation_dialog_label"});this._expressionLabel=new actuate.widget.form.Label({text:J,cellCls:"calculation_dialog_padding_top calculation_dialog_label"});this._functionSyntaxLabel=new actuate.widget.form.Label({width:300,cls:"calculation_dialog_syntax"});this._descriptionLabel=new actuate.widget.form.Label({width:300,cls:"calculation_dialog_description"});this._labelTextField=new actuate.widget.form.TextField({name:"calculationdialog_column_label",width:300});this._categoryComboBox=new actuate.widget.form.ComboBox({name:"calculationdialog_category",width:300,editable:false});this._functionListBox=new actuate.widget.form.ListBox({name:"calculationdialog_function_list",width:305,height:120});this._labelTextFieldID=this._labelTextField.getItemId();this._categoryComboBoxID=this._categoryComboBox.getItemId();this._functionListBoxID=this._functionListBox.getItemId();for(var H=0;H<this.MAX_ARGUMENTS_COUNT;H++){this._argumentLabels.push(this.__createDummyField({cellCls:"calculation_dialog_label"}));this._argumentFields.push(this._createArgumentFields(H));}A.add(E,false);A.add(this._labelTextField,false);A.add(B,false);A.add(this._categoryComboBox,false);A.add(F,false);A.add(this._functionListBox,false);A.add(this.__createDummyField(),false);A.add(this._functionSyntaxLabel,false);A.add(this.__createDummyField(),false);A.add(this._descriptionLabel,false);A.add(this.__createDummyField(),false);A.add(this._createExamplesPanel(),false);A.add(this._expressionLabel,false);A.add(this._createExpressionPanel(),false);for(var G=0;G<this.MAX_ARGUMENTS_COUNT;G++){var L=this._createArgumentPanel();for(var K in this._argumentFields[G]){L.add(this._argumentFields[G][K]);}A.add(this._argumentLabels[G],false);A.add(L,false);}this.add(A);this.resultlist=document.createElement("div");this.hintDiv=document.createElement("div");document.body.appendChild(this.resultlist);document.body.appendChild(this.hintDiv);},__initListeners:function(){actuate.dialog.impl.helper.CalculationDialog.superclass.__initListeners.apply(this,arguments);var E=actuate.Method.bind(this._onChangeHandler,this);var D=actuate.Method.bind(this.__eh_keyDown,this);var C=actuate.Method.bind(this.handleCursorMoved,this);this._labelTextField.registerEventHandler("change",E);this._categoryComboBox.registerEventHandler("select",E);this._functionListBox.registerEventHandler("select",E);this._expressionTextArea.registerEventHandler("change",E);this._expressionTextArea.registerEventHandler("keydown",D,false);this._expressionTextArea.registerEventHandler("click",C);this._expressionTextArea.registerEventHandler("keyup",C);actuate.util.Event.observe(this.resultlist,"click",actuate.Method.bindAsEventListener(this.__eh_stopEvent,this),false);actuate.util.Event.observe(document.getElementById(this.getId()),"click",actuate.Method.bindAsEventListener(this.__eh_unhandledClick,this));for(var B=0;B<this.MAX_ARGUMENTS_COUNT;B++){for(var A in this._argumentFields[B]){this._argumentFields[B][A].registerEventHandler("change",E);}}},__getHelpTopic:function(){return"iv_calculation";},_onChangeHandler:function(E,I,D){if(!E){return ;}var A=E.getItemId();switch(A){case this._labelTextFieldID:var H=I;if(this.__currentInput.label!=H){this.__currentInput.label=H;}break;case this._expressionTextAreaID:var F=I;if(this.__currentInput.expression!=F){this.__currentInput.expression=F;}break;case this._categoryComboBoxID:var B=E.getValueAt(D);if(this.__currentInput.category!=B){this.__currentInput.category=B;if(this.__currentInput.functionName!=this.ADVANCED){this.__currentInput.functionName=null;this.__currentInput.arguments=[];}this.refresh(this.CATEGORY_CHANGED);}break;case this._functionListBoxID:var G=E.getValueAt(D);if(this.__currentInput.functionName!=G){this.__currentInput.functionName=G;this.__currentInput.arguments=[];this.refresh(this.FUNCTION_CHANGED);}break;default:for(var C=0;C<this.MAX_ARGUMENTS_COUNT;C++){if(!this.__currentInput.arguments){this.__currentInput.arguments=[];}for(var J in this._argumentFieldID[C]){if(A==this._argumentFieldID[C][J]){this.__currentInput.arguments[C]=I;}}}break;}},refresh:function(A){this.initSuggestionArray();switch(A){case this.REFRESH_ALL:if(this.__currentInput.editedColumn){this._labelTextField.disable();this.setTitle(actuate.util.Utility.getLocalizedString("calculationDialog.titleText.Edit"));}this._labelTextField.setValue(this.__currentInput.label);this._updateCategoryCombo();case this.CATEGORY_CHANGED:this._updateFunctionList();case this.FUNCTION_CHANGED:this._updateDescription();this._updateArguments();this._enableAdvanceMode(this.__currentInput.functionName==this.ADVANCED);default:break;}actuate.dialog.impl.helper.CalculationDialog.superclass.refresh.apply(this,arguments);},_preHide:function(){actuate.dialog.impl.helper.CalculationDialog.superclass._preHide.apply(this,arguments);this.clearResults();this.hintDiv.style.display="none";this._hideAllArguments();},show:function(){actuate.dialog.impl.helper.CalculationDialog.superclass.show.apply(this,arguments);this.initSuggestions();this._expressionTextAreaDom=this._expressionTextArea.getEl().dom;},_enableAdvanceMode:function(A){if(A){var B=this.__currentInput.expression;this._expressionTextArea.setValue(B?B:"");this._examplesPanel.show();this._expressionLabel.show();this._expressionPanel.show();}else{this._examplesPanel.hide();this._expressionLabel.hide();this._expressionPanel.hide();}},_createArgumentFields:function(B){var A={column:new actuate.widget.form.ComboBox({width:300,editable:false,store:[["",""]]}),group:new actuate.widget.form.ComboBox({width:300,editable:false}),option:new actuate.widget.form.ComboBox({width:300,editable:false}),text:new actuate.widget.form.TextField({width:300}),number:new actuate.widget.form.TextField({width:300,validator:function(F){var E=actuate.dialog.impl.Utility.validateNumber(F);if(E!=true){E=actuate.util.Utility.getLocalizedString("calculationDialog.message.numberArgument");}return E;}})};var D={};for(var C in A){D[C]=A[C].getItemId();}if(!this._argumentFieldID){this._argumentFieldID=[];}this._argumentFieldID[B]=D;return A;},_createExamplesPanel:function(){var A=actuate.util.Utility.getLocalizedString("calculationDialog.examplesText");var D=new actuate.widget.form.Label({text:A,cls:"calculation_dialog_advanced_example"});var B=new actuate.widget.form.Label({text:'[LastName]&","&[FirstName]',cls:"calculation_dialog_advanced_example"});var C=new actuate.widget.form.Label({text:"[price]*0.10",cls:"calculation_dialog_advanced_example"});this._examplesPanel=new actuate.widget.panel.Panel({layout:new actuate.widget.panel.layout.TableLayout({rows:4}),border:false,width:300});this._examplesPanel.add(D,false);this._examplesPanel.add(B,false);this._examplesPanel.add(C,false);this._examplesPanel.add(this.__createDummyField(),false);return this._examplesPanel;},_createExpressionPanel:function(){var A=new actuate.widget.form.Label({text:actuate.util.Utility.getLocalizedString("calculationDialog.advanced.Validate"),cls:"calculation_dialog_validate"});this._expressionPanel=new actuate.widget.panel.Panel({border:false,width:300,cls:"calculation_dialog_validate",layout:new actuate.widget.panel.layout.TableLayout({columns:1})});this._expressionTextArea=new actuate.widget.form.TextArea({width:295,height:100,cls:"calculation_dialog_advanced_expression",enableKeyEvents:true});this._expressionPanel.add(this._expressionTextArea,false);this._expressionPanel.add(A,false);this._expressionTextAreaID=this._expressionTextArea.getItemId();this._validateLabelID=A.getItemId();return this._expressionPanel;},_createArgumentPanel:function(){return new actuate.widget.panel.Panel({border:false,width:308});},_updateCategoryCombo:function(){var A=this._getAvailableCategories(this.__store.Functions);this._categoryComboBox.clear();if(A){var D=[];for(var B=0;B<A.length;B++){var C=A[B];D.push([C,actuate.util.Utility.getLocalizedString("calculationDialog.category."+C)]);if(this.__currentInput.category===undefined){this.__currentInput.category=C;}}this._categoryComboBox.setStore(D);}this._categoryComboBox.setValue(this.__currentInput.category);},_getAvailableCategories:function(B){var A=[];if(B){for(var D in B){var F=B[D];if(F){for(var C=0;C<F.length;C++){var E=F[C];if(E&&this._functionIsAvailable(E.name)){A.push(D);break;}}}}}return A;},_getRequiredColumn:function(G,D){var F=G;if(D&&D.length!=null&&D.length>0){F=null;for(var B in G){var E=G[B];if(this.__currentInput.editedColumn){if(this.__currentInput.label==B){continue;}}for(var C=0;C<D.length;C++){var A=E.dataType;if(A&&A.toLowerCase()=="date-time"){A="datetime";}if(D[C]&&A&&D[C].toLowerCase()==A.toLowerCase()){if(F==null){F={};}F[B]=E;}}}}return F;},_resetComboBox:function(E,A){var B;if(A){for(var C in A){var D=C;if(A[C]&&A[C].displayName!=null){D=A[C].displayName;}E.add([C,D]);if(B===undefined){B=C;}}}if(!B){E.hide();}return B;},_updateFunctionList:function(){var B=this.__store.Functions;var D=this.__currentInput.category;this._functionListBox.setSelectedIndex(-1);this._functionListBox.clear();this._functionListBox.add(this.ADVANCED);if(B&&D){var F=B[D];if(F){for(var C=0;C<F.length;C++){var E=F[C];if(E&&this._functionIsAvailable(E.name)){this._functionListBox.add(E.name);}}}}var A=this._functionListBox.indexOfValue(this.__currentInput.functionName);if(A!=null&&A>=0){this._functionListBox.setSelectedValue(this.__currentInput.functionName);}},_updateDescription:function(){var E=this.__currentInput.functionName;this._descriptionLabel.hide();this._functionSyntaxLabel.hide();if(E){var C;var A;if(E!=this.ADVANCED){var D=this._getFunctionDef(E);var B;var F;B=D?D.name:E;id=D?D.id:null;C=actuate.util.Utility.getLocalizedString("calculationDialog."+(id?id:B)+".description");if(!C){C=D?D.description:"";}A=actuate.util.Utility.getLocalizedString("calculationDialog."+(id?id:B)+".syntax",B);if(!A){A=D?D.syntax:null;}if(!A&&B){A="<b>"+B+"</b>";}F=D?D.hint:null;if(A&&F){A=A+", "+F;}else{if(F){A=F;}}}else{C=actuate.util.Utility.getLocalizedString("calculationDialog.advanced.description");}if(C){this._descriptionLabel.show();this._descriptionLabel.setText(C,false);}if(A){this._functionSyntaxLabel.show();this._functionSyntaxLabel.setText(A,false);}}},_updateArguments:function(){var C=this.__currentInput.functionName;this._hideAllArguments();if(C){var B=this._getFunctionDef(C);var D=B?B.arguments:null;if(D){if(this._functionIsAvailable(C)){for(var A=0;A<D.length;A++){this._showArgument(B,D[A],A);}}}}},_showArgument:function(B,J,I){if(!J||!this._argumentFields[I]){return ;}var O;var Q=J.name?J.name:"text";if(!this.__currentInput.arguments){this.__currentInput.arguments=[];}O=this.__currentInput.arguments[I];if(O==null){O=J.defaultValue;}var N=this._argumentLabels[I];var G=this._argumentFields[I][Q];var H=true;switch(Q){case"column":var F=this._getRequiredColumn(this.__store.Binding,J.dataType);G.clear();var C=this._resetComboBox(G,F);if(C==null){H=false;}else{if(O==null){O=C;}}break;case"group":G.clear();G.add("");var C=this._resetComboBox(G,this.__store.Group);if(C==null){H=false;}break;case"option":var M=[];var C;if(J.values){for(var E=0;E<J.values.length;E++){var L=actuate.util.Utility.getLocalizedString("calculationDialog.option."+J.values[E].display);M.push([J.values[E].value,L]);if(C===undefined){C=J.values[E].value;}}}G.setStore(M);if(C==null){H=false;}else{if(O==null){O=C;}}break;case"text":case"number":default:break;}var K=B?B.name:K;var D=B?B.id:null;var P="calculationDialog."+(D?D:K)+".argument"+(I+1);var A=actuate.util.Utility.getLocalizedString(P);N.setText(A||J.label,false);G.setValue(O);if(H){N.show();G.show();}else{N.hide();G.hide();}this.__currentInput.arguments[I]=O;},_functionIsAvailable:function(D){var C=this._getFunctionDef(D);var E=C?C.arguments:null;if(E){for(var B=0;B<E.length;B++){var A=E[B];if(A.name=="column"){if(!this._getRequiredColumn(this.__store.Binding,A.dataType)){return false;}}}}return true;},_hideAllArguments:function(){for(var B=0;B<this.MAX_ARGUMENTS_COUNT;B++){this._argumentLabels[B].hide();for(var A in this._argumentFields[B]){this._argumentFields[B][A].hide();}}},_getFunctionDef:function(E){var A=this.__store.Functions;if(A&&E){for(var C in A){var F=A[C];if(F){for(var B=0;B<F.length;B++){var D=F[B];if(E==D.name){D.category=C;return D;}}}}}},setGroups:function(A){if(A){this.__store.Group=A;this.refresh();}},setColumnBindings:function(A){if(A){this.__store.Binding=A;this.refresh();}},setFunctions:function(A){if(A){this.__store.Functions=A;this.refresh();}},setSelectedColumn:function(C){this.__currentInput={editedColumn:C};this._labelTextField.enable();this.setTitle(actuate.util.Utility.getLocalizedString("calculationDialog.titleText.New"));if(C&&C.calculationInfo){var F=C.calculationInfo;this.__currentInput.label=F["label"]?F["label"]:C.header;if(F["function"]&&F["function"]!=this.ADVANCED){this.__currentInput.functionName=F["function"];var E=this._getFunctionDef(F["function"]);if(E){this.__currentInput.category=E.category;}}else{this.__currentInput.functionName=this.ADVANCED;this.__currentInput.expression=F["expression"]?F["expression"]:F;}if(F["arguments"]){var E=this._getFunctionDef(this.__currentInput.functionName);var G=E?E.arguments:null;if(G){this.__currentInput.arguments=[];for(var B=0;B<G.length;B++){var A=G[B];if(F["arguments"][B]!=null){var D=this._decodeArgument(F["arguments"][B].value||F["arguments"][B],A.name?A.name:"text");this.__currentInput.arguments.push(D);}}}}}this.refresh();},__createResult:function(){var E={};var D=this._getFunctionDef(this.__currentInput.functionName);if(this.__currentInput.label){E["label"]=this.__currentInput.label;}if(this.__currentInput.functionName&&this.__currentInput.functionName!=this.ADVANCED){E["function"]=this.__currentInput.functionName;if(D&&D.expression){E["expression"]=D.expression;}}else{if(this.__currentInput.expression){E["expression"]=this.__currentInput.expression;}}if(this.__currentInput.arguments){var F=D?D.arguments:null;E["arguments"]=[];if(F){for(var B=0;B<F.length;B++){if(this.__currentInput.arguments[B]!=null){var A=F[B].name;if(!A){A=this._getArgumentType(F);if(!A){A="text";}}var C={value:this._encodeArgument(this.__currentInput.arguments[B],A)};if(F[B].aggregationType){C["aggregationType"]=this._encodeArgument(F[B].aggregationType);}E["arguments"].push(C);}}}}return actuate.util.Json.makeMap(E);},_encodeArgument:function(C,A){var B=C;if(B!=null){if(A=="column"){B="["+B+"]";}else{if(A=="text"){B='"'+B+'"';}}}return B;},_decodeArgument:function(C,A){var B=C;if(B&&B.length&&B.length>=2){if(A=="column"||A=="text"){B=B.substring(1,B.length-1);}}return B;},_getArgumentType:function(C){if(C){for(var B=0;B<C.length;B++){if(C[B].name=="column"){var A=this._getColumnDataType(this.__currentInput.arguments[B]);switch(A){case"float":case"integer":case"decimal":case"double":return"number";case"string":case"time":case"date":case"datetime":default:return"text";}}}}},_getColumnDataType:function(A){var C=this.__store.Binding;if(C!=null){for(var B in C){if(B==A){return C[B].dataType;}}}},_validate:function(){var E=true;var B;if(E){var G=this.checkName(this.__currentInput.label);if(G==this._INVALID_NAME_FORMAT){E=false;B=actuate.util.Utility.getLocalizedString("calculationDialog.message.invalidLabel");}else{if(G==this._DUPLICATE_NAME){E=false;B=actuate.util.Utility.getLocalizedString("calculationDialog.message.duplicateLabel");}}}if(E&&this.__currentInput.functionName==this.ADVANCED&&!this.__currentInput.expression){E=false;B=actuate.util.Utility.getLocalizedString("calculationDialog.message.noExpression");}else{if(E&&!this.__currentInput.functionName){E=false;B=actuate.util.Utility.getLocalizedString("calculationDialog.message.noFunction");}}if(E&&this.__currentInput.arguments){var D=this._getFunctionDef(this.__currentInput.functionName);var F=D?D.arguments:null;if(F){for(var C=0;C<F.length;C++){if(F[C].name=="number"){var A=this._argumentFields[C][F[C].name];if(A.validate()==false){E=false;B=actuate.util.Utility.getLocalizedString("calculationDialog.message.numberArgument");}}}}}if(!E){this.__popupErrorDialog(B);}return E;},_neh_okay:function(){if(this._validate()){if(this.__currentInput.functionName==this.ADVANCED){this._validateExpression(actuate.Method.bind(this._validationCallback,this));}else{actuate.dialog.impl.helper.CalculationDialog.superclass._neh_okay.apply(this,arguments);}}},_validationCallback:function(A){if(A&&!A.BRDExpression["isValid"]){this.__popupErrorDialog(A.BRDExpression["parserError"]);}else{actuate.dialog.impl.helper.CalculationDialog.superclass._neh_okay.call(this);}},_validateExpression:function(C){var A={};var B=actuate.util.Json.makeMap({target:this._classname,label:this.__currentInput.label,expression:this.__currentInput.expression});A[actuate.dialog.impl.EventConstants.__E_VALIDATE_BRD_EXPRESSION]=B;return this.__sendJson(A,C?C:actuate.Method.bind(this.handleBRDValidateResult,this),null,"Table");},checkName:function(F){if(!this.__currentInput.editedColumn){if(!F||F.length==0){return this._INVALID_NAME_FORMAT;}var D=F.charAt(0);if(actuate.util.Utility.isLetter(actuate.util.Utility.convertCharacterToHalfWidth(D))==false){return this._INVALID_NAME_FORMAT;}var C,E;for(var A=1;A<F.length;A++){C=F.charAt(A);E=actuate.util.Utility.convertCharacterToHalfWidth(C);if(actuate.util.Utility.isLetter(E)==false&&actuate.util.Utility.isDigit(E)==false&&E!="_"&&E!=" "){return this._INVALID_NAME_FORMAT;}}F=actuate.util.String.trim(F);for(var B in this.__store.Binding){if(F.toLowerCase()==B.toLowerCase()){return this._DUPLICATE_NAME;}}}return this._VALID_NAME;},__eh_keyDown:function(C,B){if(!B){return ;}this.stopEvent(B);var A=B.getKey();var D=String.fromCharCode(A).toLowerCase();switch(A){case B.ENTER:this.handleEnter();break;case B.SHIFT:break;case B.UP:this.handleUp();break;case B.DOWN:this.handleDown();break;default:if(B.ctrlKey&&(D=="c"||D=="v"||D=="a")){break;}else{this.populateSuggestions(B,A);}if(this.suggestions.length==0){return ;}this.appendSuggestions();}},handleEnter:function(){this.updateTextFromSelection();this.clearResults();this.currentEntry="";},handleDown:function(){if(this.suggestions.length>0&&this.suggestionSelection<this.suggestions.length-1){this.removeCurrentSelection();this.suggestionSelection++;this.setCurrentSelection();this.handleSuggestionScroll(true);}},handleUp:function(){if(this.suggestions.length>0&&this.suggestionSelection>0){this.removeCurrentSelection();this.suggestionSelection--;this.setCurrentSelection();this.handleSuggestionScroll(false);}},updateTextFromSelection:function(){if(this.suggestionSelection==-1){return ;}if(!this.suggestions||this.suggestions.length<=this.suggestionSelection){this.suggestionSelection=-1;return ;}var C=this.suggestions[this.suggestionSelection];var G=C.indexOf(")")-C.indexOf("(")>2;var C=this.stripParameters(C);this.suggestionSelection=-1;var B="";if(this._expressionTextAreaDom.createTextRange){this._expressionTextArea.focus();var A=this.selectionRange;A.collapse(false);A.moveStart("character",-this.currentEntry.length);A.text=C;if(G){A.move("character",-(C.length-C.indexOf("(")-1));}A.select();}else{var H=this.getCursorPosTextarea(this._expressionTextAreaDom);B=this._expressionTextArea.getValue().substring(0,H);var D=H-this.currentEntry.length;var E=B.substring(0,D);var F=this._expressionTextArea.getValue().substring(H,this._expressionTextArea.getValue().length);this._expressionTextArea.setValue(E+C+F);this._expressionTextArea.focus();this._expressionTextAreaDom.setSelectionRange(H+this._expressionTextArea.getValue().length,H+this._expressionTextArea.getValue().length);}this.__currentInput.expression=this._expressionTextArea.getValue();},initSuggestions:function(){this.suggestions=[];this.suggestionSelection=-1;this.currentEntry="";},initSuggestionArray:function(){this.suggestionArray=new Array("true","false","AND","OR","LEFT( str )","RIGHT( str )","ROUND( num )","ROUNDDOWN( num )","ROUNDUP( num )","SEARCH( pattern, str )","FIND( strToFind, str )","IN( value, check1, ..., checkN )");var A=this.__store.Functions;for(var C in A){var E=A[C];if(E){for(var B=0;B<E.length;B++){var D=E[B];if(D&&D.hint){this.suggestionArray.push(D.hint);}}}}this.suggestionArray.sort();this.handleBoundDataColumn();},stripParameters:function(H){if(H.charAt(0)=="["&&H.charAt(H.length-1)=="]"){return H;}var C=H.indexOf("(");if(C==-1){return H;}var E=H.indexOf(")");if(E==-1){return H;}var B=H.substring(C+1,E);var A=new Array();A=B.split(",");var D=" ";for(var G=0;G<A.length-1;G++){D+=", ";}var F=H.substring(0,C+1)+D+H.substring(E,H.length);return F;},getCursorPosTextarea:function(A){if(A.selectionStart!=undefined){return(A.selectionEnd);}else{A.focus();return(document.selection.createRange());}},clearResults:function(){this.resultlist.style.display="none";this.suggestionSelection=-1;this.suggestions=[];while(this.resultlist.hasChildNodes()){this.resultlist.removeChild(this.resultlist.firstChild);}},removeCurrentSelection:function(){if(this.suggestionSelection>=0&&this.suggestionSelection<this.resultlist.childNodes.length){var A=this.resultlist.childNodes[this.suggestionSelection];A.className="calculation_dialog_result";}},setCurrentSelection:function(){if(this.suggestionSelection>=0&&this.suggestionSelection<this.resultlist.childNodes.length){var A=this.resultlist.childNodes[this.suggestionSelection];A.className="calculation_dialog_sresult";}},handleSuggestionScroll:function(E){var C=this.resultlist.getElementsByTagName("div");if(C!=null&&C.length>0){var D=C[0];var A=D.offsetHeight;var B=A*(this.suggestionSelection+1);if(E==true){if(B>this.resultlist.clientHeight){this.resultlist.scrollTop+=A;}}else{if((B-A)<this.resultlist.scrollTop){this.resultlist.scrollTop-=A;}}}},populateSuggestions:function(D,A){if(this._expressionTextAreaDom.createTextRange){this._expressionTextArea.focus();this.selectionRange=document.selection.createRange();}this.clearResults();if((navigator.userAgent.match(/iPhone/i))||(navigator.userAgent.match(/iPod/i))){var C="";switch(A){case 91:C="[";break;case 93:C="]";break;case 123:C="{";break;case 125:C="}";break;case 95:C="_";break;case 46:C=".";break;case 41:C=")";break;default:C=String.fromCharCode(A);}if(A==127){var B=this.getSelectionLength();if(B==0){B=1;}if(this.currentEntry.length>B){this.currentEntry=this.currentEntry.substring(0,this.currentEntry.length-B);}else{this.currentEntry="";}this.updateSuggestions("");}else{if((A>=65&&A<=90)||(A>=48&&A<=57)||A==91||A==93||A==123||A==125||A==95||A==46||A==44||A==32){this.updateSuggestions(C);}else{this.currentEntry="";}}}else{var C="";switch(A){case 48:if(D.shiftKey){C=")";}else{C="0";}break;case 57:if(D.shiftKey){C="(";}else{C="9";}break;case 109:if(!actuate.util.browser.__isIE()){if(D.shiftKey){C="_";}else{C="-";}break;}case 188:if(D.shiftKey){C="<";}else{C=",";}break;case 189:if(actuate.util.browser.__isIE()){if(D.shiftKey){C="_";}else{C="-";}break;}case 190:if(D.shiftKey){C=">";}else{C=".";}break;case 219:if(D.shiftKey){C="{";}else{C="[";}break;case 221:if(D.shiftKey){C="}";}else{C="]";}break;default:C=String.fromCharCode(A);}if(A==D.BACKSPACE){var B=this.getSelectionLength();if(B==0){B=1;}if(this.currentEntry.length>B){this.currentEntry=this.currentEntry.substring(0,this.currentEntry.length-B);}else{this.currentEntry="";}this.updateSuggestions("");}else{if((A>=65&&A<=90)||(A>=48&&A<=57)||A==219||A==221||(A==190&&D.shiftKey==true)||(A==109&&D.shiftKey==true&&!actuate.util.browser.__isIE())||(A==189&&D.shiftKey==true&&actuate.util.browser.__isIE())||A==188||A==32){this.updateSuggestions(C);}else{this.currentEntry="";}}}},getSelectionLength:function(){var A=this._expressionTextAreaDom;if(A.createTextRange){this._expressionTextArea.focus();this.selectionRange=document.selection.createRange();return this.selectionRange.text.length;}else{return A.selectionEnd-A.selectionStart;}},updateSuggestions:function(E){if(E=="["){this.suggestionSelection=0;this.currentEntry=E;}else{if(!(this.currentEntry==""&&E==" ")){this.currentEntry+=E;}}if(this.currentEntry==""){this.suggestionSelection=-1;return ;}for(var B=0;B<this.suggestionArray.length;B++){var F=this.suggestionArray[B];var A=this.suggestionArray[F];var D=actuate.util.String.trim(F.toLowerCase());var G=actuate.util.String.trim(this.currentEntry.toLowerCase());var C=D.indexOf(G);if(C==0){this.suggestions.push(F);if(A!=null){this.suggestions[F]=A;}if(this.suggestions.length==100){return ;}if(this.suggestionSelection==-1){this.suggestionSelection=0;}}}},handleMouseOver:function(D){this.removeHighlight();var B=actuate.util.Event.element(D);if(!B){return ;}B.className="calculation_dialog_sresult";var E=B.innerHTML;for(var A=0;A<this.suggestions.length;A++){var C=this.suggestions[A];if(E.indexOf(C)>-1){this.suggestionSelection=A;return ;}}},handleMouseOut:function(B){var A=actuate.util.Event.element(B);if(!A){return ;}A.className="calculation_dialog_result";this.suggestionSelection=-1;},handleMouseClick:function(A){this.handleEnter();},removeHighlight:function(){this.suggestionSelection=-1;var B=this.resultlist.getElementsByTagName("div");for(var A=0;A<B.length;A++){B[A].className="calculation_dialog_result";}},getKeyCode:function(B){var A=0;if(B.keyCode){A=B.keyCode;}else{if(B.which){A=B.which;}}return A;},getStringBeforeCursor:function(){if(this._expressionTextAreaDom.createTextRange){this._expressionTextArea.focus();this.selectionRange=document.selection.createRange();var A=this.selectionRange.duplicate();A.moveToElementText(this._expressionTextAreaDom);A.setEndPoint("EndToEnd",this.selectionRange);return A.text;}else{var B=this.getCursorPosTextarea(this._expressionTextAreaDom);return this._expressionTextArea.getValue().substring(0,B);}},findCurrentOpenIndex:function(A){if(A==null){return null;}var C=new Array();var E=false;for(var B=0;B<A.length;B++){var D=A.charAt(B);if(D=='"'){if(!E){E=true;}else{E=false;}}else{if(D=="("&&!E){C.push(B);}else{if(D==")"&&C.length>0&&!E){C.pop();}}}}return C.pop();},findFunctionFromOverloaded:function(B,G){var D=this._expressionTextArea.getValue().substring(G+1,this._expressionTextArea.getValue().length-1);var F=0;var J=0;for(var E=0;E<D.length;E++){var A=D.charAt(E);if(A=="("){if(J==0){J++;}F++;}else{if(A==")"){if(F>0){F--;}else{break;}}else{if(A==","){if(J==0){J=2;}else{J++;}}else{if(A!=" "){if(J==0){J++;}}}}}}B.sort(actuate.Method.bind(this.sortByNumOfParams,this));for(var E=0;E<B.length;E++){var C=B[E];var I=C.substring(C.indexOf("(")+1,C.indexOf(")"));var H=this.getNumberOfParams(C);if(J<=H){return C;}}},getNumberOfParams:function(C){var A=C.substring(C.indexOf("(")+1,C.indexOf(")"));var B=0;A=A?A.replace(/^\s+|\s+$/g,""):null;return A?A.split(",").length:0;},findCurrentParam:function(){var D=this.getStringBeforeCursor();var C=this.findCurrentOpenIndex(D);var A=D.substring(C+1,D.length);var G=1;var B=0;var H=false;for(var E=0;E<A.length;E++){var F=A.charAt(E);if(F=='"'){if(!H){H=true;}else{H=false;}}else{if(F=="("&&!H){B++;}else{if(F==")"&&!H){B--;}else{if(F==","&&B==0&&!H){G++;}}}}}return G;},getCursorPosition:function(){var D=this._expressionTextAreaDom.offsetWidth;var B=this._expressionTextArea.getValue();var A=B.length;var E=B.split("\n");var F=-1;if(typeof document.selection!="undefined"){range_sel=document.selection.createRange();range_obj=this._expressionTextAreaDom.createTextRange();range_obj.moveToBookmark(range_sel.getBookmark());range_obj.moveEnd("character",this._expressionTextArea.getValue().length);F=A-range_obj.text.length;}else{if(typeof this._expressionTextAreaDom.selectionStart!="undefined"){F=this._expressionTextAreaDom.selectionStart;}}if(F!=-1){var C=0;for(;C<E.length;C++){A=E[C].length+1;if(F<A){break;}F-=A;}C++;F++;return[C,F];}},getStyle:function(A,B){var C="";if(document.defaultView&&document.defaultView.getComputedStyle){C=document.defaultView.getComputedStyle(A,"").getPropertyValue(B);}else{if(A.currentStyle){B=B.replace(/\-(\w)/g,function(D,E){return E.toUpperCase();});C=A.currentStyle[B];}}return C;},getYCoord:function(C){var B=10;var A=C[0]*B+this._getElementPosition(this._expressionTextAreaDom).top;if(A<0){A=0;}A=A-2*B-10;return A;},getXCoord:function(F){var A=4;var B=this._expressionTextAreaDom.offsetWidth;var E=Math.floor(B/A);var C=F[1];if(C>E){C=E;}var D=(C-1)*(A)+this._getElementPosition(this._expressionTextAreaDom).left;return D;},__eh_unhandledClick:function(B){this.clearResults();this.currentEntry="";var A=actuate.util.Event.element(B).id;if(this._expressionTextAreaDom&&A==this._expressionTextAreaDom.id){return ;}this.hintDiv.style.display="none";switch(A){case this._validateLabelID:if(this.__currentInput.functionName==this.ADVANCED&&!this.__currentInput.expression){this.__popupErrorDialog(actuate.util.Utility.getLocalizedString("calculationDialog.message.noExpression"));}else{this._validateExpression();}break;case this._operatorsID:this.__openHelp("iv_operators");break;case this._functionsID:this.__openHelp("iv_functions");break;case this.helpLink:break;default:actuate.util.Event.stop(B);break;}},_getElementPosition:function(C){var E=C;var B=0;var A=0;var D;while(C!=null){if(!D){D=actuate.uiadapter.Element.fly(C).getStyle("z-index");}B+=C.offsetLeft;A+=C.offsetTop;C=C.offsetParent;}return{left:B,top:A,width:E.offsetWidth,height:E.offsetHeight,zIndex:D};},appendSuggestions:function(){var D=this._getElementPosition(document.getElementById(this.getId()));for(var B=0;B<this.suggestions.length;B++){var A=this.suggestions[B];if(this.suggestions[A]!=null){A+=" - "+this.suggestions[A];}var C=document.createElement("DIV");C.innerHTML=A;if(B==0){C.className="calculation_dialog_sresult";}else{C.className="calculation_dialog_result";}actuate.util.Event.observe(C,"mouseover",actuate.Method.bindAsEventListener(this.handleMouseOver,this));actuate.util.Event.observe(C,"mouseout",actuate.Method.bindAsEventListener(this.handleMouseOut,this));actuate.util.Event.observe(C,"click",actuate.Method.bindAsEventListener(this.handleMouseClick,this));this.resultlist.appendChild(C);}if(actuate.util.browser.__isIE()){this.resultlist.style.marginTop="0px";}this.resultlist.style.display="block";this.resultlist.style.position="absolute";this.resultlist.style.height="100px";this.resultlist.style.width="300px";this.resultlist.style.borderStyle="solid";this.resultlist.style.borderWidth="1px";this.resultlist.style.borderColor="#cccccc";this.resultlist.style.backgroundColor="white";this.resultlist.style.overflow="auto";this.resultlist.style.font="11px/16px tahoma, verdana, arial, sans-serif";this.resultlist.style.zIndex=(D.zIndex+500);this.resultlist.style.left=(D.left+125)+"px";this.resultlist.style.top=(D.top+D.height-83)+"px";this.resultlist.scrollTop=0;},handleBoundDataColumn:function(){if(!this.__store||!this.__store.Binding){return ;}for(var B in this.__store.Binding){var E=this.__store.Binding[B];var C=E.dataType;if(!C||C==actuate.Constant.DataType.ANY){continue;}if(this.__currentInput.editedColumn){if(E.expression){var A="["+this.__currentInput.label+"]";if(E.expression.indexOf(A)>=0||E.name==this.__currentInput.label){continue;}}}var D=E.getBRDEscapedName();this.suggestionArray.push(D);if(E.name!=E.displayName){this.suggestionArray[D]=E.displayName;}}},handleCursorMoved:function(H,A){if(A.type=="keyup"){var J=this.getKeyCode(A);if(J<37||J>40){return ;}}var I=this.findCurrentFunction();if(!I){this.hintDiv.style.display="none";return ;}var L=this.findCurrentParam();var K=I.substring(I.indexOf("(")+1,I.indexOf(")"));var G=new Array();G=K.split(",");var C=I.substring(0,I.indexOf("(")+1);for(var F=0;F<G.length;F++){if(F==L-1){C+="<b>"+G[F]+"</b>";}else{C+=G[F];}if(F<G.length-1){C+=", ";}}C+=I.substring(I.indexOf(")"),I.length);this.hintDiv.innerHTML=C;this.hintDiv.style.display="block";var D=this.getCursorPosition();var E=this.getYCoord(D);var B=this.getXCoord(D);this.hintDiv.style.left=B+"px";this.hintDiv.style.top=E+"px";this.hintDiv.style.zIndex=(this._getElementPosition(document.getElementById(this.getId())).zIndex+500);this.hintDiv.style.font="11px/16px tahoma, verdana, arial, sans-serif";this.hintDiv.className="calculation_dialog_expressionHint";},findCurrentFunction:function(){var F=this.getStringBeforeCursor();var C=this.findCurrentOpenIndex(F);if(!C||C<0){return ;}var I=F.substring(0,C);if(I==null){return null;}var J=I.split(this.functionBreakRE);var K=J[J.length-1];var E=new Array();for(var D=0;D<this.suggestionArray.length;D++){var B=this.suggestionArray[D];var H=B.indexOf("(");if(H==-1){continue;}var G=B.substring(0,H);if(K&&K.toLowerCase()==G.toLowerCase()){E.push(B);}}if(E.length==0){return null;}if(E.length==1){return E.pop();}var A=this.findFunctionFromOverloaded(E,C);return A;},sortByNumOfParams:function(C,B){var A=this.getNumberOfParams(C);var D=this.getNumberOfParams(B);return((A<D)?-1:((A>D)?1:0));},handleBRDValidateResult:function(A){if(A&&A.BRDExpression){if(!A.BRDExpression["isValid"]){this.__popupErrorDialog(A.BRDExpression["parserError"]);}else{this.__popupInformationDialog(actuate.util.Utility.getLocalizedString("calculationDialog.message.validExpression"));}}},__eh_stopEvent:function(A){actuate.util.Event.stop(A);},stopEvent:function(B){if(!B){return ;}var A=this.getKeyCode(B);if(this.suggestions.length>0&&A==13){actuate.util.Event.stop(B);}if(this.suggestions.length>0&&(A==40||A==38||A==13)){actuate.util.Event.stop(B);}}});
actuate.util.Package.define("actuate.dialog.impl.helper.gadgetbuilder");actuate.dialog.impl.helper.gadgetbuilder.SparkLineDataTab=actuate.Class.extendClass(actuate.dialog.impl.helper.AbstractDataTabDialog,{_classname:"actuate.dialog.impl.helper.gadgetbuilder.SparkLineDataTab",_selectedIid:null,_clearFilterUI:true,initialize:function(){this.id=this._getId(this._classname);this._title=actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.data");actuate.dialog.impl.helper.AbstractDataTabDialog.prototype.initialize.call(this);this.__initDataSourceCombo();this._valueDefinitionCombo=actuate.widget.ComponentMgr.get(this.id+"_valuedefinitioncombo");this._groupByCombo=actuate.widget.ComponentMgr.get(this.id+"_groupBycombo");this._agregateExpression=actuate.widget.ComponentMgr.get(this.id+"_agregateExpression");this._hyperlinkCheckbox=actuate.widget.ComponentMgr.get(this.id+"_hyperlinkCheckbox");this._installEventHandlers();this._initializeControlStatus();},_initializeControlStatus:function(){this._validateControlArray=[];this._validateControlArray.push(this._valueDefinitionCombo);},__createDataSourceCombo:function(){return actuate.widget.ComponentMgr.get(this.id+"_datasetcombo");},_initContent:function(){this._componentArray=[];var A=this;this._valueDefinitionStore=new actuate.widget.data.SimpleStore({fields:["valueDefinitionValue","valueDefinitionText","title","valueDefinitionType","hasAction"]});this._groupByStore=new actuate.widget.data.SimpleStore({fields:["valueDefinitionValue","valueDefinitionText","title","valueDefinitionType","hasAction"]});var C={xtype:"fieldset",collapsible:true,title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.data"),checkboxToggle:false,defaults:{border:false,layout:"column",bodyStyle:"padding:2px 4px 2px 10px"},listeners:{collapse:function(){if(A._parentDialog&&A._parentDialog.adjustSize){A._parentDialog.adjustSize();}},expand:function(){if(A._parentDialog&&A._parentDialog.adjustSize){A._parentDialog.adjustSize();}}},cls:"actuate-widget-panle-zero-margin-top",items:[{layout:"column",items:[{layout:"form",border:false,labelWidth:112,items:[{id:this.id+"_datasetcombo",width:286,fieldLabel:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.useDataFrom"),xtype:"treecombo",forceSelection:true,autoExpand:true,style:"margin-right:3px",editable:false,valueField:"value",displayField:"title",titleField:"title",icons:this.__dataSourceIcons,sortInfo:{folderSort:true,field:"text",direction:"ASC"},showTooltip:true,store:new actuate.widget.custom.TreeCombo.TreeComboStore(this.__dataSourceComboStore)}]}]},{items:[{id:this.id+"_hyperlinkCheckbox",xtype:"checkbox",checked:true,boxLabel:actuate.util.Utility.getLocalizedString("common.dataTab.useHyperlink")}]}]};var B={xtype:"fieldset",collapsible:true,autoHeight:true,title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Value"),checkboxToggle:false,defaults:{border:false,header:false,layout:"column",bodyStyle:"padding:2px 4px 2px 10px"},listeners:{collapse:function(){if(A._parentDialog&&A._parentDialog.adjustSize){A._parentDialog.adjustSize();}},expand:function(){if(A._parentDialog&&A._parentDialog.adjustSize){A._parentDialog.adjustSize();}}},items:[{items:[{columnWidth:0.1,xtype:"label",style:"height:1px"},{columnWidth:0.3,xtype:"label",style:"height:1px",text:""},{columnWidth:0.2,xtype:"label",text:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.dataColumns")}]},{items:[{columnWidth:0.26,xtype:"label",text:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.selectValue")},{id:this.id+"_valuedefinitioncombo",columnWidth:0.633,xtype:"treecombo",editable:false,forceSelection:true,valueField:"valueDefinitionValue",displayField:"valueDefinitionText",titleField:"title",autoExpand:true,showTooltip:true,icons:this.__icons,store:new actuate.widget.custom.TreeCombo.TreeComboStore(this._valueDefinitionStore),validator:function(H){var G=false;var I=actuate.widget.ComponentMgr.get(A.id+"_valuedefinitioncombo");var F=I.getSelectedIndex();var D=I.getValueAt(F);if(D){var E=D.valueDefinitionType;G=E=="integer"||E=="decimal"||E=="float";}if(G==false){return actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.Spark.valueDef.numericTypeNotMatch");}return G;}}]},{items:[{columnWidth:0.26,xtype:"label",text:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.groupBy")},{id:this.id+"_groupBycombo",columnWidth:0.633,xtype:"treecombo",editable:false,forceSelection:true,valueField:"valueDefinitionValue",displayField:"valueDefinitionText",titleField:"title",autoExpand:true,showTooltip:true,icons:this.__icons,store:new actuate.widget.custom.TreeCombo.TreeComboStore(this._groupByStore)}]}]};this._componentArray.push(C);this._componentArray.push(B);},validate:function(){var A=this._isDataCubeSelected();var B=this._isDataSetSelected();if(!(A||B)){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.alertTitle"),msg:actuate.util.Utility.getLocalizedString("common.dataTab.noDataSourceError"),buttons:actuate.widget.MessageBox.OK});return false;}if(!this._getTreeComboValue(this._valueDefinitionCombo)){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.alertTitle"),msg:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.noValueDefError"),buttons:actuate.widget.MessageBox.OK});return false;}if(!this._valueDefinitionCombo.isValid()){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.alertTitle"),msg:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.valueDef.typeNotMatch"),buttons:actuate.widget.MessageBox.OK});return false;}if(!this._groupByCombo.disabled&&!this._getTreeComboValue(this._groupByCombo)){actuate.widget.MessageBox.show({title:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.alertTitle"),msg:actuate.util.Utility.getLocalizedString("flashGadgetBuilderDialog.noGroupDefError"),buttons:actuate.widget.MessageBox.OK});return false;}return true;},_installEventHandlers:function(){var A=actuate.Method.bind(this._eh_datasetComboChange,this);var B=actuate.Method.bind(this._eh_onBeforeSelect,this);this.__dataSourceCombo.registerEventHandler("change",A);this._valueDefinitionCombo.registerEventHandler("beforeselect",B);this._groupByCombo.registerEventHandler("beforeselect",B);},loadData:function(B){this._hasNewDatamart=false;if(B.Element&&B.Element.iid){this._selectedIid=B.Element.iid;}else{this._selectedIid=null;}if(B.DataMarts){this._data=B;this._clearControls();this.__showAllDataSources();this.__onSelectDataSource();}if(B.Filter){this._filter=B.Filter;}if(B.DataSet&&B.DataSet.dataSourceName){this.__selectDataSource(B.DataSet,"dataset");this._groupByCombo.disable();this.__onSelectDataSource();}else{if(B.Cube&&B.Cube.dataSourceName){this.__selectDataSource(B.Cube,"cube");this._groupByCombo.enable();this.__onSelectDataSource();}}if(B.ValueDefinitions){for(var A in B.ValueDefinitions){if(A){this.__setTreeComboValue(this._valueDefinitionCombo,B.ValueDefinitions[A].Query);if(B.ValueDefinitions[A].GroupBy){this.__setTreeComboValue(this._groupByCombo,B.ValueDefinitions[A].GroupBy);}}}}var C=null;if(B.Element!=null&&B.Element.copyHyperlink!=null){C=B.Element.copyHyperlink=="true"?true:false;}if(C==true){this._hyperlinkCheckbox.setValue(true);}else{if(C==false){this._hyperlinkCheckbox.setValue(false);}}},_changeFilterPanel:function(B){if(this._parentDialog._filterPanel){var C={};var A=this.__getSelectedDataSourceInfo();if(A){C.dataObject=[A[1],A[4],A[3]];C.dataObjectSoap=this.createDataSetSoap(true);C.dataMartSoap=this._dataManagerSoap;C.clearFilterUI=this._clearFilterUI;C.target="FlashGadgets";}if(this._filter){C.Filter=this._filter;}this._parentDialog._filterPanel.loadData(C);}},_updateFilter:function(A){this._filterSoap=A;this._clearFilterUI=false;},__onSelectDataSource:function(){var A=this.__getSelectedDataSourceInfo();var B=A?A[1].columns:[];if(B&&B.length>0){this._groupByCombo.disable();}var C=A?A[1].dimensions:[];if(C){this._groupByCombo.enable();}this._resetAllTreeCombo();actuate.dialog.impl.helper.gadgetbuilder.SparkLineDataTab.superclass.__onSelectDataSource.call(this);},_resetAllTreeCombo:function(){var B=this.__dataSourceCombo.getValue();var A={id:"none",strong:true,value:"",text:""};this._valueDefinitionStore.removeAll();this._groupByStore.removeAll();this.__addDataIntoTreeStore(A,this._valueDefinitionStore);this.__addDataIntoTreeStore(A,this._groupByStore);this.__setTreeStoreValues(this._valueDefinitionStore,B,["category","column","measure"]);this.__setTreeStoreValues(this._groupByStore,B,["category","column","dimension"]);if(this._isDataModelSelected()){this._valueDefinitionCombo.expandDeep=1;this._groupByCombo.expandDeep=1;}else{this._valueDefinitionCombo.expandDeep=null;this._groupByCombo.expandDeep=null;}this._valueDefinitionCombo.refresh();this._groupByCombo.refresh();this._valueDefinitionCombo.setValueById("none");this._groupByCombo.setValueById("none");},_eh_datasetComboChange:function(){this.__selectionChangedHandler();},_preHide:function(){this._hasNewDatamart=false;this._clearControls();this.hidden=true;},_clearControls:function(){this.__dataSourceCombo.clear();this.__dataSourceCombo.setValue("");this._groupByCombo.clear();this._groupByCombo.setValueById("none");this._valueDefinitionCombo.clear();this._valueDefinitionCombo.setValueById("none");actuate.widget.ComponentMgr.get(this.id+"_hyperlinkCheckbox").enable();actuate.widget.ComponentMgr.get(this.id+"_hyperlinkCheckbox").setValue(true);this._selectedIid=null;this._clearFilterUI=true;this._filter=null;},getDataSelection:function(){var A=this.__getSelectedDataSourceInfo();if(A&&A[1]){return{dataSourceName:A[1].name};}return null;},createDataSetSoap:function(I){var H=actuate.util.XmlDom.createXMLDom(actuate.util.Constants.soap.NAMESPACE_ACTUATE10,actuate.Constant.tag.Data);if(this.__dataSourceComboStore){var J=this.__getSelectedDataSourceInfo();var M=J[1].name;var F=J[0];if(F==null||F==undefined){F="";}var K=J[2];if(J[1].dimensions){if(I==true){G=actuate.util.XmlDom.createElement(H,"Cube");}else{G=actuate.util.XmlDom.createElement(H,"CubeDef");}var C=actuate.util.XmlDom.createElement(H,"Name");var D=H.createTextNode(M);C.appendChild(D);G.appendChild(C);}else{var G=actuate.util.XmlDom.createElement(H,"DataSetDef");var C=actuate.util.XmlDom.createElement(H,"Name");var D=H.createTextNode(M);C.appendChild(D);G.appendChild(C);}var B=actuate.util.XmlDom.createElement(H,"DataSource");var P=J[4];if(P){var A=(P.toLowerCase()=="data")?actuate.dialog.impl.constant.DataMartAccessType.LATEST:actuate.dialog.impl.constant.DataMartAccessType.TRANSIENT;var N=actuate.util.XmlDom.createElement(H,"Type");N.appendChild(H.createTextNode(A));B.appendChild(N);}if(F){var O=actuate.util.XmlDom.createElement(H,"DisplayName");O.appendChild(H.createTextNode(F));B.appendChild(O);}var L=actuate.util.XmlDom.createElement(H,"DataMartName");D=H.createTextNode(K);L.appendChild(D);B.appendChild(L);G.appendChild(B);return G;}else{var E=this.__getSelectedDataSourceInfo();var M=E?E.name:"";var F="";var G=actuate.util.XmlDom.createElement(H,"DataSetDef");var C=actuate.util.XmlDom.createElement(H,"Name");var D=H.createTextNode(M);C.appendChild(D);G.appendChild(C);var B=actuate.util.XmlDom.createElement(H,"DataSource");var O=actuate.util.XmlDom.createElement(H,"DisplayName");D=H.createTextNode(F);O.appendChild(D);B.appendChild(O);G.appendChild(B);return G;}return null;},createSoapNode:function(F,D){if(this._selectedIid){D.documentElement.setAttribute("iid",this._selectedIid);}var N=this.createDataSetSoap();F.appendChild(N);var E=actuate.util.XmlDom.createElement(D,actuate.Constant.tag.Query);var O=actuate.util.XmlDom.createElement(D,"DataField");var R=this._getTreeComboValue(this._valueDefinitionCombo);var J=D.createTextNode(R);O.appendChild(J);E.appendChild(O);var G=this._valueDefinitionCombo.getValue();if(G){var L=actuate.util.XmlDom.createElement(D,"DataType");var A=G.valueDefinitionType;var S=D.createTextNode(A);L.appendChild(S);E.appendChild(L);}F.appendChild(E);if(this._filterSoap!=null){D.documentElement.appendChild(this._filterSoap);}var Q=actuate.util.XmlDom.createElement(D,actuate.Constant.tag.Json);D.documentElement.appendChild(Q);if(this._dataManagerSoap!=null){var M=this._dataManagerSoap.childNodes[0].data;var C=M.substr(0,M.length-1)+",";var K=D.createTextNode(C);Q.appendChild(K);}var B=actuate.util.Json;var P="";if(this._hyperlinkCheckbox.disabled==false){P="UseHyperlink:";if(Q.childNodes.length==0){P="{UseHyperlink:";}var I={};I.value=this._hyperlinkCheckbox.getValue().toString();P+=B.makeMap(I)+",";}P+="GroupBy:";if(P.indexOf("UseHyperlink")<0&&Q.childNodes.length==0){P="{GroupBy:";}I={};I.value=this._getTreeComboValue(this._groupByCombo);P+=B.makeMap(I)+"}";var H=D.createTextNode(P);Q.appendChild(H);},__addDataIntoTreeStore:function(C,A){if(A&&C&&!(C.value&&C.value.dataType=="blob")){var B=C.value;if(B&&B.type=="column"&&this._isSummaryTable){if((A==this._valueDefinitionStore&&B.isDimension)||(A==this._groupByStore&&!B.isDimension)){return ;}}C.valueDefinitionValue=C;C.valueDefinitionText=C.text;C.valueDefinitionType=this._getDataType(C);C.title=this._getTooltip(C);C.dimension=this._getDimension(C);C.hasAction=this._hasAction(C);C.isDimension=this._isDimension(C);C.disabled=this._isDisabled(C,A);A.add(new A.recordType(C,C.id));}},_isDisabled:function(B,A){if(actuate.dialog.impl.helper.gadgetbuilder.SparkLineDataTab.superclass._isDisabled.apply(this,arguments)){return true;}if(this._isSummaryTable&&B.type=="column"){if(A==this._valueDefinitionStore){return B.isDimension?true:false;}else{if(A==this._groupByStore){return B.isDimension?false:true;}}}return false;},_getTreeComboValueByRecord:function(B){var A;if(B){A=B.value;}if(B&&B.value&&B.value.type){var E=B.value;switch(E.type){case"attribute":var F=E.fullName;if(F){F=F.replace(/\"/g,'\\"');A='row["'+F+'"]';}break;case"column":var C=E.name;if(C){C=C.replace(/\"/g,'\\"');A='row["'+C+'"]';}break;case"level":if(E.dataType!="blob"){levelFullName=E.fullName;if(E.dataType=="integer"&&E.attributes&&E.attributes.length>0){for(var G=0;G<E.attributes.length;G++){var D=E.attributes[G];if(D&&D.name=="DateTime"&&(D.dataType=="date"||D.dataType=="time"||D.dataType=="datetime"||D.dataType=="date-time")){levelFullName=D.fullName;break;}}}A='data["'+levelFullName+'"]';}break;case"measure":if(E.dataType!="blob"){A='data["'+E.groupName+"/"+E.name+'"]';}break;default:A=E.name;break;}}return A;},_eh_onBeforeSelect:function(B,A){if(A&&A.data&&A.data.valueDefinitionValue){return actuate.dialog.impl.helper.gadgetbuilder.SparkLineDataTab.superclass._eh_onBeforeSelect.call(this,B,A.data.valueDefinitionValue.node);}return true;},__supportAttributes:function(A){return false;}});